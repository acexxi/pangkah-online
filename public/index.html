<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pangkah Murim</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Bonheur+Royale&display=swap" rel="stylesheet">
    <style>
        :root { --primary-action: #10b981; --ui-blue: #3b82f6; --glass: rgba(255,255,255,0.08); --glass-heavy: rgba(15,23,42,0.65); --glass-light: rgba(255,255,255,0.12); --border: rgba(255,255,255,0.18); --border-light: rgba(255,255,255,0.25); --danger: #f43f5e; --gold: #fbbf24; --purple: #a855f7; --legendary: linear-gradient(135deg, #fbbf24, #f59e0b); --epic: linear-gradient(135deg, #a855f7, #7c3aed); --rare: linear-gradient(135deg, #3b82f6, #2563eb); --common: linear-gradient(135deg, #6b7280, #4b5563); --table-bg: url('/murim.jpg'); --murim-gold: #d4af37; --murim-glow: #ffd700; }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100vh; overflow: hidden; background: var(--table-bg) center/cover no-repeat fixed; color: white; display: flex; flex-direction: column; }
        #lobby { position: fixed; inset: 0; z-index: 5000; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
        .panel { width: 90%; max-width: 400px; padding: 35px; border-radius: 24px; background: var(--glass-heavy); border: 1px solid var(--border-light); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .murim-logo { width: 100%; max-width: 320px; height: auto; margin-bottom: 25px; filter: drop-shadow(0 0 8px var(--murim-glow)) drop-shadow(0 0 15px rgba(255,215,0,0.4)); animation: logoGlow 2s ease-in-out infinite alternate; }
        @keyframes logoGlow { 0% { filter: drop-shadow(0 0 8px var(--murim-glow)) drop-shadow(0 0 15px rgba(255,215,0,0.4)); } 100% { filter: drop-shadow(0 0 12px var(--murim-glow)) drop-shadow(0 0 20px rgba(255,215,0,0.5)); } }
        .room-list { height: 120px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 16px; margin: 15px 0; border: 1px solid var(--border); }
        .room-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; cursor: pointer; font-size: 0.85rem; transition: background 0.2s; }
        .room-item:hover { background: rgba(255,255,255,0.05); }
        .room-item.in-game { opacity: 0.5; }
        .modal-overlay { position: fixed; inset: 0; z-index: 6000; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        #profile-modal .profile-card, #titles-modal .titles-card, .gameover-card { width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; padding: 30px 20px; background: var(--glass-heavy); border-radius: 24px; text-align: center; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        #profile-modal .profile-card { border: 1px solid var(--ui-blue); }
        #titles-modal .titles-card { border: 1px solid var(--purple); }
        .gameover-card { border: 1px solid var(--danger); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 15px 10px; border-radius: 16px; border: 1px solid var(--border); }
        .stat-value { font-size: 24px; font-weight: 800; color: var(--ui-blue); }
        .stat-label { font-size: 9px; opacity: 0.6; margin-top: 4px; text-transform: uppercase; }
        .bar-container { width: 100%; height: 10px; background: rgba(255,255,255,0.05); border-radius: 20px; margin: 10px 0; overflow: hidden; border: 1px solid var(--border); }
        .bar-fill { height: 100%; background: linear-gradient(90deg, var(--ui-blue), var(--primary-action)); width: 0%; transition: width 0.6s ease; }
        .title-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
        .title-item { padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); cursor: pointer; transition: all 0.2s; text-align: left; position: relative; }
        .title-item:hover { transform: scale(1.02); }
        .title-item.locked { opacity: 0.4; cursor: not-allowed; }
        .title-item.equipped { border-color: var(--gold); box-shadow: 0 0 15px rgba(251,191,36,0.3); }
        .title-name { font-weight: 800; font-size: 11px; margin-bottom: 4px; }
        .title-desc { font-size: 9px; opacity: 0.6; }
        .title-rarity { font-size: 8px; font-weight: 800; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 6px; }
        .title-rarity.legendary { background: var(--legendary); color: #000; }
        .title-rarity.epic { background: var(--epic); color: #fff; }
        .title-rarity.rare { background: var(--rare); color: #fff; }
        .title-rarity.common { background: var(--common); color: #fff; }
        .title-progress { font-size: 8px; color: var(--ui-blue); margin-top: 4px; }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .filter-tab { padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; cursor: pointer; border: 1px solid var(--border); background: rgba(0,0,0,0.3); }
        .filter-tab.active { background: var(--ui-blue); border-color: var(--ui-blue); }
        #swap-modal { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--glass-heavy); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 30px; border-radius: 24px; border: 1px solid #f59e0b; z-index: 10001; display: none; text-align: center; width: 90%; max-width: 320px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        #round-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--glass-heavy); border: 1px solid var(--border-light); padding: 40px 50px; border-radius: 24px; text-align: center; z-index: 9999; display: none; min-width: 300px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .pangkah-text { color: var(--danger); font-size: 2.2rem; font-weight: 900; text-shadow: 0 0 20px var(--danger); }
        .clean-text { color: var(--ui-blue); font-size: 2.2rem; font-weight: 900; text-shadow: 0 0 20px var(--ui-blue); }
        #gameover-modal { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; padding: 20px; }
        .finish-list { margin: 20px 0; }
        .finish-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid var(--border); }
        .finish-item.winner { border-color: var(--gold); background: rgba(251,191,36,0.1); }
        .finish-item.loser { border-color: var(--danger); background: rgba(244,63,94,0.1); }
        .bonus-list { background: rgba(0,0,0,0.3); border-radius: 16px; padding: 15px; margin: 15px 0; text-align: left; }
        .bonus-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
        .bonus-item:last-child { border-bottom: none; }
        .rematch-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
        #achievement-popup { position: fixed; top: 100px; right: 20px; background: var(--glass-heavy); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 20px; border-radius: 20px; border: 1px solid var(--gold); z-index: 10002; display: none; min-width: 280px; animation: slideIn 0.5s ease; box-shadow: 0 8px 32px rgba(251,191,36,0.2); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .header { height: 70px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-light); background: var(--glass-heavy); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 4px 30px rgba(0,0,0,0.2); }
        #your-turn-btn { background: var(--primary-action); color: #000; font-size: 11px; font-weight: 900; padding: 8px 18px; border-radius: 25px; border: none; display: none; animation: pulse-glow 1.5s infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px var(--primary-action); } 50% { box-shadow: 0 0 20px var(--primary-action); } }
        #game-view { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .safe-wrap { position: relative; width: 100%; height: 100%; }
        #t-layer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; pointer-events: none; }
        .player { position: absolute; text-align: center; z-index: 100; transition: all 0.3s ease; }
        
        /* Custom Avatar Frame - 205 x 70 */
        .av { position: relative; width: 205px; height: 70px; background: url('/avatar-frame.png') center/contain no-repeat; display: flex; align-items: center; }
        
        /* Left Hexagon - Take Hand (clickable area) */
        .av-take-hand { position: absolute; left: 0px; top: 50%; transform: translateY(-50%); width: 36px; height: 55px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.2s; border-radius: 4px; }
        .av-take-hand.visible { opacity: 1; pointer-events: auto; }
        .av-take-hand.visible.greyed { opacity: 0.5; cursor: not-allowed; }
        .av-take-hand.visible.greyed::after { color: #6b7280; text-shadow: none; }
        .av-take-hand.visible.greyed:hover { background: transparent; }
        .av-take-hand:hover { background: rgba(16,185,129,0.3); }
        .av-take-hand::after { content: 'TH'; font-size: 12px; font-weight: 900; color: #10b981; text-shadow: 0 0 8px #10b981, 0 1px 2px rgba(0,0,0,0.8); }
        
        /* Avatar Square - 52x52 */
        .av-avatar { position: absolute; left: 38px; top: 50%; transform: translateY(-50%); width: 52px; height: 52px; border-radius: 8px; background: transparent; overflow: hidden; }
        .av-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Center Info - Level, Name, Title */
        .av-info { position: absolute; left: 100px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: flex-start; justify-content: center; gap: 0px; width: 70px; }
        .av-level { font-size: 7px; font-weight: 800; color: #10b981; text-transform: uppercase; text-shadow: 0 1px 2px rgba(0,0,0,0.8); line-height: 1.2; }
        .av-name { font-size: 11px; font-weight: 800; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65px; line-height: 1.3; }
        .av-title { font-size: 7px; font-weight: 600; color: rgba(255,255,255,0.7); text-shadow: 0 1px 2px rgba(0,0,0,0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65px; line-height: 1.2; }
        
        /* Right Hexagon - Card Count (orange, same size as TH) */
        .av-cards { position: absolute; right: -2px; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: 900; color: #f59e0b; text-shadow: 0 0 8px #f59e0b, 0 1px 2px rgba(0,0,0,0.8); width: 36px; text-align: center; }
        
        /* Active player glow */
        .active .av { filter: drop-shadow(0 0 12px var(--primary-action)); }
        .player.eliminated .av { opacity: 0.3; filter: grayscale(1); }
        #hand-area { height: 28vh; background: var(--glass-heavy); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid var(--border-light); padding: 15px; overflow-y: auto; z-index: 2000; box-shadow: 0 -4px 30px rgba(0,0,0,0.2); position: relative; }
        .hand-header { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px; }
        #turn-indicator-inline { background: var(--primary-action); color: #000; font-size: 11px; font-weight: 900; padding: 8px 16px; border-radius: 20px; display: none; animation: pulse-glow 1.5s infinite; }
        #turn-indicator-inline.active { display: flex; align-items: center; gap: 5px; }
        #turn-timer { font-weight: 900; margin-left: 4px; }
        .hand-flex { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; padding-bottom: 20px; }
        .card { width: 50px; height: 75px; background: rgba(255,255,255,0.95); color: black; border-radius: 12px; padding: 6px; font-weight: 800; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; border: 1px solid rgba(255,255,255,0.5); transition: transform 0.15s, box-shadow 0.15s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .card:hover { transform: translateY(-8px); box-shadow: 0 12px 28px rgba(0,0,0,0.35); }
        .card.red { color: var(--danger) !important; }
        .card.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .card.highlight { border: 2px solid var(--primary-action); box-shadow: 0 0 10px var(--primary-action); }
        .table-card { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 105px; border: 2px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.6); pointer-events: none; z-index: 50; animation: cardDrop 0.4s ease; }
        @keyframes cardDrop { from { transform: translate(-50%, -200%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .pangkah-flash { position: fixed; inset: 0; background: rgba(244,63,94,0.3); z-index: 9998; pointer-events: none; animation: flash 0.5s ease; }
        .clean-flash { position: fixed; inset: 0; background: rgba(59,130,246,0.2); z-index: 9998; pointer-events: none; animation: flash 0.5s ease; }
        @keyframes flash { 0% { opacity: 1; } 100% { opacity: 0; } }
        #streak-indicator { position: fixed; top: 80px; left: 20px; background: var(--glass-heavy); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 10px 15px; border-radius: 16px; border: 1px solid var(--gold); display: none; z-index: 100; box-shadow: 0 4px 20px rgba(251,191,36,0.2); }
        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--danger); padding: 12px 24px; border-radius: 12px; z-index: 10003; display: none; font-weight: 800; font-size: 13px; }
        .btn { padding: 14px; border-radius: 16px; font-weight: 800; cursor: pointer; width: 100%; border: none; transition: all 0.2s; }
        .btn-p { background: linear-gradient(135deg, var(--ui-blue), #2563eb); color: #fff; box-shadow: 0 4px 15px rgba(59,130,246,0.4); }
        .btn-p:hover { box-shadow: 0 6px 20px rgba(59,130,246,0.5); transform: translateY(-2px); }
        .btn-s { background: var(--glass-light); border: 1px solid var(--border-light); color: #fff; font-size: 11px; backdrop-filter: blur(10px); }
        .btn-s:hover { background: rgba(255,255,255,0.18); }
        .btn-gold { background: var(--legendary); color: #000; box-shadow: 0 4px 15px rgba(251,191,36,0.4); }
        .btn-gold:hover { box-shadow: 0 6px 20px rgba(251,191,36,0.5); transform: translateY(-2px); }
        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 14px; background: var(--glass-light); color: #fff; border: 1px solid var(--border-light); outline: none; backdrop-filter: blur(10px); transition: all 0.2s; }
        input:focus, select:focus { border-color: var(--ui-blue); box-shadow: 0 0 15px rgba(59,130,246,0.3); }
        select option { background: #1e293b; color: #fff; padding: 10px; }
        #discard-area { position: absolute; left: 15px; top: 85px; display: flex; flex-direction: row; gap: 8px; z-index: 10; align-items: flex-start; flex-wrap: wrap; max-width: 200px; background: var(--glass-heavy); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 12px; border-radius: 16px; border: 1px solid var(--border-light); }
        .fate-label { font-size: 10px; opacity: 0.8; width: 100%; margin-bottom: 5px; color: var(--gold); font-weight: 800; }
        .fate-card { width: 45px; height: 65px; background: rgba(255,255,255,0.95); border-radius: 10px; font-size: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid var(--gold); }
        .fate-card.black { color: #000; }
        .fate-card.red { color: var(--danger); }
        .table-cards-row { display: flex; gap: 8px; padding: 15px 20px; background: var(--glass); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid var(--border); }
        .table-card { position: relative; top: auto; left: auto; transform: none; width: 60px; height: 90px; border: 2px solid rgba(255,255,255,0.6); box-shadow: 0 8px 25px rgba(0,0,0,0.4); pointer-events: none; animation: cardDrop 0.4s ease; flex-shrink: 0; border-radius: 12px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9998; display: none; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary-action); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #connection-status { position: fixed; bottom: 10px; right: 10px; font-size: 10px; padding: 4px 8px; background: rgba(0,0,0,0.5); border-radius: 8px; z-index: 100; }
        .xp-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: 900; color: var(--primary-action); z-index: 10004; pointer-events: none; animation: xpFloat 1.5s ease forwards; }
        @keyframes xpFloat { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -100%) scale(1.5); } }
        
        /* Screen Edge Glow - Your Turn Indicator */
        #turn-glow { position: fixed; inset: 0; pointer-events: none; z-index: 9000; opacity: 0; transition: opacity 0.3s; }
        #turn-glow.active { opacity: 1; }
        #turn-glow::before { content: ''; position: absolute; inset: 0; border: 4px solid var(--primary-action); border-radius: 0; box-shadow: inset 0 0 60px var(--primary-action), 0 0 30px var(--primary-action); animation: glowPulse 1.5s ease-in-out infinite; }
        @keyframes glowPulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        
        /* Quick Emotes - in hand area */
        #emote-bar { display: flex; flex-direction: row; gap: 6px; background: var(--glass); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 6px 10px; border-radius: 20px; border: 1px solid var(--border-light); }
        .emote-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--glass-light); border: 1px solid var(--border); font-size: 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .emote-btn:hover { transform: scale(1.15); background: rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(255,255,255,0.1); }
        .emote-btn:active { transform: scale(0.95); }
        .emote-float { position: fixed; font-size: 48px; pointer-events: none; z-index: 10005; animation: emoteFloat 2s ease forwards; }
        @keyframes emoteFloat { 0% { opacity: 1; transform: scale(0.5) translateY(0); } 20% { transform: scale(1.2) translateY(-20px); } 100% { opacity: 0; transform: scale(1) translateY(-150px); } }
        .emote-from { position: absolute; background: var(--glass-heavy); padding: 4px 8px; border-radius: 8px; font-size: 10px; white-space: nowrap; bottom: -20px; left: 50%; transform: translateX(-50%); }
        
        /* Confetti */
        .confetti { position: fixed; width: 10px; height: 10px; top: -10px; z-index: 10006; pointer-events: none; animation: confettiFall linear forwards; }
        @keyframes confettiFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .confetti.square { border-radius: 2px; }
        .confetti.circle { border-radius: 50%; }
        .confetti.star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
    </style>
</head>
<body>
<div id="toast"></div>
<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div id="connection-status">üü¢ Connected</div>
<div id="achievement-popup"></div>
<div id="streak-indicator"><span>üî•</span><span id="streak-count">0</span><div style="font-size:9px;opacity:0.6">WIN STREAK</div></div>

<!-- Screen Edge Glow for Your Turn -->
<div id="turn-glow"></div>

<div class="modal-overlay" id="profile-modal">
    <div class="profile-card">
        <h3 style="color:var(--ui-blue);margin-top:0">CULTIVATION PROFILE</h3>
        <div id="prof-equipped-title" style="margin-bottom:15px"></div>
        <div id="prof-level" style="font-size:28px;font-weight:800">LEVEL 1</div>
        <div id="prof-rank-title" style="color:var(--primary-action);margin-bottom:15px">APPRENTICE</div>
        <div style="text-align:right;font-size:10px;color:#aaa" id="prof-progress-text">XP: 0/100</div>
        <div class="bar-container"><div id="prof-bar-fill" class="bar-fill"></div></div>
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-value" id="prof-xp">0</div><div class="stat-label">Total XP</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-wins">0</div><div class="stat-label">1st Place</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-pangkahs">0</div><div class="stat-label">Pangkahs</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-games">0</div><div class="stat-label">Games</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-streak">0</div><div class="stat-label">Best Streak</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-winrate">0%</div><div class="stat-label">Win Rate</div></div>
        </div>
        <button class="btn btn-gold" onclick="openTitles()" style="margin-bottom:10px">üèÜ VIEW TITLES</button>
        <button class="btn btn-p" onclick="closeProfile()">RETURN</button>
    </div>
</div>

<div class="modal-overlay" id="titles-modal">
    <div class="titles-card">
        <h3 style="color:var(--purple);margin-top:0">üèÜ ACHIEVEMENT TITLES</h3>
        <p style="font-size:11px;opacity:0.6;margin-bottom:20px">Unlock titles and equip one to display!</p>
        <div class="filter-tabs" id="title-filters"></div>
        <div class="title-grid" id="title-grid"></div>
        <button class="btn btn-s" onclick="closeTitles()" style="margin-top:15px">BACK</button>
    </div>
</div>

<div id="swap-modal">
    <div id="swap-txt" style="font-size:14px;margin-bottom:20px;font-weight:600"></div>
    <div id="swap-timer" style="font-size:12px;margin-bottom:15px;color:#f59e0b">15s</div>
    <div style="display:flex;gap:12px">
        <button class="btn btn-p" onclick="answerSwap(true)">ACCEPT</button>
        <button class="btn" onclick="answerSwap(false)" style="background:rgba(255,255,255,0.1);color:white">DECLINE</button>
    </div>
</div>

<div class="modal-overlay" id="gameover-modal">
    <div class="gameover-card">
        <h2 style="color:var(--danger);margin-top:0">‚öîÔ∏è DUEL COMPLETE</h2>
        <div id="game-number" style="font-size:11px;opacity:0.6;margin-bottom:15px"></div>
        <div class="finish-list" id="finish-list"></div>
        <div class="bonus-list" id="bonus-list"></div>
        <div class="rematch-section">
            <div id="rematch-status" style="font-size:12px;margin-bottom:15px;color:var(--ui-blue)">Waiting...</div>
            <button class="btn btn-gold" id="rematch-btn" onclick="requestRematch()">‚ö° REMATCH</button>
            <button class="btn btn-s" onclick="location.reload()" style="margin-top:10px">LEAVE</button>
        </div>
    </div>
</div>

<div id="lobby">
    <div class="panel">
        <img src="/PM-logo.png" alt="Pangkah Murim" class="murim-logo">
        <div style="margin-bottom:20px;padding:15px;background:rgba(255,255,255,0.03);border-radius:20px;border:1px solid var(--border)">
            <div style="display:flex;justify-content:center;align-items:center;gap:8px">
                <span id="display-name" style="color:var(--ui-blue);font-size:1.1rem;font-weight:800"></span>
                <span onclick="editName()" style="color:var(--primary-action);cursor:pointer;font-size:0.7rem">[EDIT]</span>
            </div>
            <div id="lobby-title" style="margin:8px 0"></div>
            <div id="level-title" style="color:var(--primary-action);font-size:12px">LEVEL 1</div>
            <button class="btn btn-s" onclick="openProfile()" style="margin-top:12px">VIEW PROFILE üìú</button>
        </div>
        <div class="room-list" id="room-box"></div>
        <input id="rid" placeholder="Enter Sect ID" maxlength="20">
        <select id="maxp">
            <option value="4">4 Players</option>
            <option value="5">5 Players</option>
            <option value="6">6 Players</option>
            <option value="7">7 Players</option>
            <option value="8">8 Players</option>
            <option value="10">10 Players</option>
        </select>
        <button class="btn btn-p" onclick="enter('create')">CREATE SECT</button>
        <button class="btn btn-s" onclick="enter('join')" style="margin-top:8px">JOIN SECT</button>
    </div>
</div>

<div id="round-popup"><div id="pop-title"></div><div id="pop-desc"></div></div>

<div class="header">
    <div id="room-tag" style="color:var(--ui-blue);font-weight:800;font-size:11px">LOBBY</div>
    <div id="fate-display" style="display:none;align-items:center;background:rgba(0,0,0,0.3);padding:4px 12px;border-radius:10px;font-size:12px"></div>
    <div style="display:flex;align-items:center;gap:12px">
        <button id="close-room-btn" onclick="closeRoom()" style="display:none;background:var(--danger);color:white;border:none;padding:6px 12px;border-radius:8px;font-size:10px;font-weight:800;cursor:pointer">DISBAND</button>
        <div id="suit-indicator" style="display:none;align-items:center;background:rgba(255,255,255,0.05);padding:4px 10px;border-radius:10px"><span id="suit-symbol" style="font-size:1.2rem"></span></div>
    </div>
</div>

<div id="game-view">
    <div class="safe-wrap" id="table-wrap">
        <div id="p-layer"></div>
        <div id="t-layer"></div>
        <button id="start-btn" class="btn" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:auto;padding:15px 30px;font-size:14px" onclick="start()">BEGIN DUEL (0/0)</button>
    </div>
</div>

<div id="hand-area">
    <div class="hand-header">
        <div id="turn-indicator-inline">‚ö° YOUR TURN <span id="turn-timer"></span></div>
        <button class="btn" style="width:auto;padding:6px 18px;font-size:11px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid var(--border-light);border-radius:12px" onclick="sortHand()">SORT ‚áÖ</button>
        <div id="emote-bar">
            <button class="emote-btn" onclick="sendEmote('üòÇ')">üòÇ</button>
            <button class="emote-btn" onclick="sendEmote('üëç')">üëç</button>
            <button class="emote-btn" onclick="sendEmote('üò°')">üò°</button>
            <button class="emote-btn" onclick="sendEmote('üî•')">üî•</button>
            <button class="emote-btn" onclick="sendEmote('üíÄ')">üíÄ</button>
            <button class="emote-btn" onclick="sendEmote('üëè')">üëè</button>
        </div>
    </div>
    <div class="hand-flex" id="my-cards"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// Audio setup with proper paths and error handling
const sfx = {
    place: new Audio('/place.mp3'),
    sweep: new Audio('/sweep.mp3'),
    strike: new Audio('/strike.mp3'),
    absorb: new Audio('/absorb.mp3')
};
Object.values(sfx).forEach(a => { a.volume = 0.3; a.load(); });

// Enable audio after first user interaction (browser policy)
let audioEnabled = false;
function enableAudio() {
    if (audioEnabled) return;
    audioEnabled = true;
    Object.values(sfx).forEach(a => {
        a.play().then(() => a.pause()).catch(() => {});
        a.currentTime = 0;
    });
    document.removeEventListener('click', enableAudio);
    document.removeEventListener('touchstart', enableAudio);
}
document.addEventListener('click', enableAudio);
document.addEventListener('touchstart', enableAudio);

function playSound(name) {
    if (sfx[name]) {
        sfx[name].currentTime = 0;
        sfx[name].play().catch(() => {});
    }
}

const TITLES=[{id:'ancient_ancestor',name:'Ancient Ancestor',desc:'Reach Level 50',rarity:'legendary',icon:'üêâ',req:{t:'level',v:50}},{id:'pangkah_god',name:'Pangkah God',desc:'500 Pangkahs',rarity:'legendary',icon:'‚ö°',req:{t:'pangkahs',v:500}},{id:'unbreakable',name:'The Unbreakable',desc:'10 win streak',rarity:'legendary',icon:'üíé',req:{t:'streak',v:10}},{id:'thousand_victories',name:'Thousand Victories',desc:'Win 1000 games',rarity:'legendary',icon:'üëë',req:{t:'wins',v:1000}},{id:'sect_master',name:'Sect Master',desc:'Play 2000 games',rarity:'legendary',icon:'üèØ',req:{t:'games',v:2000}},{id:'immortal',name:'Immortal',desc:'100,000 XP',rarity:'legendary',icon:'‚ú®',req:{t:'xp',v:100000}},{id:'grandmaster',name:'Grandmaster',desc:'Reach Level 30',rarity:'epic',icon:'üé≠',req:{t:'level',v:30}},{id:'pangkah_master',name:'Pangkah Master',desc:'200 Pangkahs',rarity:'epic',icon:'üî•',req:{t:'pangkahs',v:200}},{id:'untouchable',name:'Untouchable',desc:'7 win streak',rarity:'epic',icon:'üõ°Ô∏è',req:{t:'streak',v:7}},{id:'champion',name:'Champion',desc:'Win 500 games',rarity:'epic',icon:'üèÜ',req:{t:'wins',v:500}},{id:'veteran',name:'Battle Veteran',desc:'Play 1000 games',rarity:'epic',icon:'‚öîÔ∏è',req:{t:'games',v:1000}},{id:'enlightened',name:'Enlightened One',desc:'50,000 XP',rarity:'epic',icon:'üåü',req:{t:'xp',v:50000}},{id:'absorber',name:'Soul Absorber',desc:'Absorb 100 hands',rarity:'epic',icon:'üëª',req:{t:'handsAbsorbed',v:100}},{id:'night_owl',name:'Night Owl',desc:'100 night games',rarity:'epic',icon:'ü¶â',req:{t:'nightGames',v:100}},{id:'master',name:'Master',desc:'Reach Level 15',rarity:'rare',icon:'üéØ',req:{t:'level',v:15}},{id:'pangkah_adept',name:'Pangkah Adept',desc:'50 Pangkahs',rarity:'rare',icon:'üí•',req:{t:'pangkahs',v:50}},{id:'hot_streak',name:'Hot Streak',desc:'5 win streak',rarity:'rare',icon:'üåä',req:{t:'streak',v:5}},{id:'conqueror',name:'Conqueror',desc:'Win 100 games',rarity:'rare',icon:'üó°Ô∏è',req:{t:'wins',v:100}},{id:'dedicated',name:'Dedicated',desc:'Play 500 games',rarity:'rare',icon:'üìø',req:{t:'games',v:500}},{id:'cultivator',name:'Cultivator',desc:'10,000 XP',rarity:'rare',icon:'üå±',req:{t:'xp',v:10000}},{id:'hand_collector',name:'Hand Collector',desc:'Absorb 30 hands',rarity:'rare',icon:'ü§≤',req:{t:'handsAbsorbed',v:30}},{id:'social',name:'Social Butterfly',desc:'50 unique players',rarity:'rare',icon:'ü¶ã',req:{t:'uniquePlayers',v:50}},{id:'consistent',name:'Consistent',desc:'Top 2 in 50 games',rarity:'rare',icon:'üìà',req:{t:'topTwo',v:50}},{id:'second_best',name:'Always Second',desc:'2nd place 25 times',rarity:'rare',icon:'ü•à',req:{t:'secondPlace',v:25}},{id:'warrior',name:'Warrior',desc:'Reach Level 5',rarity:'common',icon:'‚öîÔ∏è',req:{t:'level',v:5}},{id:'first_pangkah',name:'First Strike',desc:'First Pangkah',rarity:'common',icon:'üéØ',req:{t:'pangkahs',v:1}},{id:'first_blood',name:'First Blood',desc:'Win first game',rarity:'common',icon:'ü©∏',req:{t:'wins',v:1}},{id:'newcomer',name:'Newcomer',desc:'Play 10 games',rarity:'common',icon:'üåü',req:{t:'games',v:10}},{id:'regular',name:'Regular',desc:'Play 50 games',rarity:'common',icon:'üéÆ',req:{t:'games',v:50}},{id:'learner',name:'Quick Learner',desc:'1,000 XP',rarity:'common',icon:'üìö',req:{t:'xp',v:1000}},{id:'pangkah_novice',name:'Pangkah Novice',desc:'10 Pangkahs',rarity:'common',icon:'üî∞',req:{t:'pangkahs',v:10}},{id:'victor',name:'Victor',desc:'Win 10 games',rarity:'common',icon:'üèÖ',req:{t:'wins',v:10}},{id:'determined',name:'Determined',desc:'Win 25 games',rarity:'common',icon:'üí™',req:{t:'wins',v:25}},{id:'hand_taker',name:'Hand Taker',desc:'Absorb 5 hands',rarity:'common',icon:'‚úã',req:{t:'handsAbsorbed',v:5}},{id:'streak_starter',name:'Streak Starter',desc:'3 win streak',rarity:'common',icon:'üî•',req:{t:'streak',v:3}},{id:'persistent',name:'Persistent',desc:'Play 100 games',rarity:'common',icon:'üé≤',req:{t:'games',v:100}},{id:'collector',name:'Card Collector',desc:'Play 1000 cards',rarity:'common',icon:'üÉè',req:{t:'cardsPlayed',v:1000}},{id:'runner_up',name:'Runner Up',desc:'2nd place 5 times',rarity:'common',icon:'ü•à',req:{t:'secondPlace',v:5}},{id:'third_wheel',name:'Third Wheel',desc:'3rd place 5 times',rarity:'common',icon:'ü•â',req:{t:'thirdPlace',v:5}}];
const socket=io(),icons={Spades:'‚ô†',Hearts:'‚ô•',Diamonds:'‚ô¶',Clubs:'‚ô£'},XP_PER_LEVEL=100;

// ============ VERSION RESET SYSTEM ============
// Change this number to force all players to reset their stats
const STATS_VERSION = 1;
// =============================================

let userID=localStorage.getItem('pUserID')||'uid_'+Math.random().toString(36).substr(2,9);localStorage.setItem('pUserID',userID);
let myName=localStorage.getItem('pName')||'Disciple'+Math.floor(Math.random()*999);
const DEFAULT_STATS={version:STATS_VERSION,xp:0,pangkahs:0,wins:0,losses:0,games:0,currentStreak:0,bestStreak:0,handsAbsorbed:0,cardsPlayed:0,secondPlace:0,thirdPlace:0,topTwo:0,nightGames:0,uniquePlayers:[],unlockedTitles:[],equippedTitle:null};

// Load stats and check version
let savedStats=JSON.parse(localStorage.getItem('pStats')||'{}');
if(!savedStats.version||savedStats.version<STATS_VERSION){
    console.log(`Stats reset: version ${savedStats.version||'none'} ‚Üí ${STATS_VERSION}`);
    savedStats={...DEFAULT_STATS};
    localStorage.setItem('pStats',JSON.stringify(savedStats));
}
let stats={...DEFAULT_STATS,...savedStats};
let myRoom='',myCurrentHand=[],pendingSwapRequest=null,swapTimeoutId=null,isProcessingTurn=false,isHost=false,isFirstMove=true,currentLeadSuit=null,currentFilter='all',rematchRequested=false,currentMaxPlayers=4;

function getStatValue(t){switch(t){case'level':return getLevel();case'pangkahs':return stats.pangkahs||0;case'streak':return stats.bestStreak||0;case'wins':return stats.wins||0;case'games':return stats.games||0;case'xp':return stats.xp||0;case'handsAbsorbed':return stats.handsAbsorbed||0;case'nightGames':return stats.nightGames||0;case'uniquePlayers':return(stats.uniquePlayers||[]).length;case'topTwo':return stats.topTwo||0;case'secondPlace':return stats.secondPlace||0;case'thirdPlace':return stats.thirdPlace||0;case'cardsPlayed':return stats.cardsPlayed||0;default:return 0;}}
function checkAllTitles(){TITLES.forEach(t=>{if(!stats.unlockedTitles.includes(t.id)&&getStatValue(t.req.t)>=t.req.v){stats.unlockedTitles.push(t.id);showAchievement(t);}});saveStats();}
function showAchievement(t){const p=document.getElementById('achievement-popup');p.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><span style="font-size:24px">${t.icon}</span><div><div style="font-size:10px;color:var(--gold);font-weight:800">TITLE UNLOCKED!</div><div style="font-size:16px;font-weight:800">${t.name}</div></div></div><div style="font-size:11px;opacity:0.7">${t.desc}</div><div class="title-rarity ${t.rarity}" style="margin-top:10px">${t.rarity.toUpperCase()}</div>`;p.style.display='block';setTimeout(()=>p.style.display='none',4000);}
function equipTitle(id){if(stats.unlockedTitles.includes(id)){stats.equippedTitle=id;saveStats();updateStatsUI();renderTitleGrid();if(myRoom)socket.emit('updateTitle',{roomID:myRoom,userID,title:getEquippedTitleData()});showToast('Equipped!',true);}}
function unequipTitle(){stats.equippedTitle=null;saveStats();updateStatsUI();renderTitleGrid();if(myRoom)socket.emit('updateTitle',{roomID:myRoom,userID,title:null});}
function getEquippedTitleData(){if(!stats.equippedTitle)return null;const t=TITLES.find(x=>x.id===stats.equippedTitle);return t?{id:t.id,name:t.name,rarity:t.rarity,icon:t.icon}:null;}
function renderTitleGrid(){const grid=document.getElementById('title-grid'),filters=document.getElementById('title-filters');filters.innerHTML=['all','legendary','epic','rare','common'].map(r=>`<div class="filter-tab ${currentFilter===r?'active':''}" onclick="currentFilter='${r}';renderTitleGrid()">${r==='all'?'ALL':r.toUpperCase()}</div>`).join('');const filtered=currentFilter==='all'?TITLES:TITLES.filter(t=>t.rarity===currentFilter);grid.innerHTML=filtered.map(t=>{const unlocked=stats.unlockedTitles.includes(t.id),equipped=stats.equippedTitle===t.id,prog=getStatValue(t.req.t),max=t.req.v,pct=Math.min(prog/max*100,100).toFixed(0);return`<div class="title-item ${unlocked?'':'locked'} ${equipped?'equipped':''}" onclick="${unlocked?(equipped?'unequipTitle()':`equipTitle('${t.id}')`):''}">${equipped?'<span style="position:absolute;top:8px;right:8px">‚úì</span>':''}<span class="title-rarity ${t.rarity}">${t.rarity.toUpperCase()}</span><div class="title-name">${t.icon} ${t.name}</div><div class="title-desc">${t.desc}</div>${!unlocked?`<div class="title-progress">${Math.min(prog,max)}/${max} (${pct}%)</div>`:''}</div>`;}).join('');}
function openTitles(){document.getElementById('profile-modal').style.display='none';document.getElementById('titles-modal').style.display='flex';renderTitleGrid();}
function closeTitles(){document.getElementById('titles-modal').style.display='none';document.getElementById('profile-modal').style.display='flex';}
function getLevel(){return Math.floor((stats.xp||0)/XP_PER_LEVEL)+1;}
function getRankTitle(l){return l<=5?'APPRENTICE':l<=10?'WARRIOR':l<=15?'MASTER':l<=20?'GRANDMASTER':l<=30?'ELDER':l<=50?'SECT LEADER':'ANCIENT ANCESTOR';}
function saveStats(){localStorage.setItem('pStats',JSON.stringify(stats));}
function addXP(amt,reason,popup=true){const old=getLevel();stats.xp=Math.max(0,(stats.xp||0)+amt);saveStats();if(getLevel()>old)showToast(`‚ö° LEVEL UP! Lv.${getLevel()}`,true);if(popup&&amt){const p=document.createElement('div');p.className='xp-popup';p.style.color=amt>0?'var(--primary-action)':'var(--danger)';p.innerText=`${amt>0?'+':''}${amt} XP`;document.body.appendChild(p);setTimeout(()=>p.remove(),1500);}updateStatsUI();checkAllTitles();}
function updateStatsUI(){const lv=getLevel(),rt=getRankTitle(lv),xp=(stats.xp||0)%XP_PER_LEVEL,wr=stats.games>0?((stats.wins/stats.games)*100).toFixed(1):0,eq=getEquippedTitleData();document.getElementById('display-name').innerText=myName;document.getElementById('level-title').innerText=`LEVEL ${lv} - ${rt}`;document.getElementById('lobby-title').innerHTML=eq?`<span class="title-rarity ${eq.rarity}" style="font-size:10px">${eq.icon} ${eq.name}</span>`:'';document.getElementById('prof-level').innerText=`LEVEL ${lv}`;document.getElementById('prof-rank-title').innerText=rt;document.getElementById('prof-xp').innerText=stats.xp||0;document.getElementById('prof-wins').innerText=stats.wins||0;document.getElementById('prof-pangkahs').innerText=stats.pangkahs||0;document.getElementById('prof-games').innerText=stats.games||0;document.getElementById('prof-streak').innerText=stats.bestStreak||0;document.getElementById('prof-winrate').innerText=wr+'%';document.getElementById('prof-progress-text').innerText=`XP: ${xp}/${XP_PER_LEVEL}`;document.getElementById('prof-bar-fill').style.width=(xp/XP_PER_LEVEL*100)+'%';document.getElementById('prof-equipped-title').innerHTML=eq?`<span class="title-rarity ${eq.rarity}">${eq.icon} ${eq.name}</span>`:'<span style="opacity:0.5;font-size:11px">No title equipped</span>';document.getElementById('streak-indicator').style.display=stats.currentStreak>=3?'block':'none';document.getElementById('streak-count').innerText=stats.currentStreak||0;}
function editName(){const n=prompt("Enter Name:",myName);if(n?.trim()&&n.trim().length<=20){myName=n.trim();localStorage.setItem('pName',myName);updateStatsUI();}}
function openProfile(){updateStatsUI();document.getElementById('profile-modal').style.display='flex';}
function closeProfile(){document.getElementById('profile-modal').style.display='none';}
function showToast(msg,pos=false){const t=document.getElementById('toast');t.innerText=msg;t.style.background=pos?'var(--primary-action)':'var(--danger)';t.style.display='block';setTimeout(()=>t.style.display='none',3000);}
function showLoading(s){document.getElementById('loading').style.display=s?'flex':'none';}
function flashScreen(type){const f=document.createElement('div');f.className=type+'-flash';document.body.appendChild(f);setTimeout(()=>f.remove(),500);}

// Turn Indicator - Screen Edge Glow + Inline
function setTurnIndicator(isMyTurn){
    document.getElementById('turn-glow').classList.toggle('active',isMyTurn);
    document.getElementById('turn-indicator-inline').classList.toggle('active',isMyTurn);
}

// Quick Emotes
function sendEmote(emoji){
    if(!myRoom)return;
    socket.emit('sendEmote',{roomID:myRoom,userID,playerName:myName,emoji});
    showEmote(emoji,myName,true);
}
function showEmote(emoji,fromName,isMe=false){
    const e=document.createElement('div');
    e.className='emote-float';
    e.innerHTML=`${emoji}<div class="emote-from">${isMe?'You':fromName}</div>`;
    e.style.left=Math.random()*60+20+'%';
    e.style.top='50%';
    document.body.appendChild(e);
    setTimeout(()=>e.remove(),2000);
}
socket.on('receiveEmote',d=>{
    if(d.userID!==userID)showEmote(d.emoji,d.playerName);
});

// Confetti Effect
function launchConfetti(){
    const colors=['#fbbf24','#f59e0b','#10b981','#3b82f6','#a855f7','#f43f5e','#ffffff'];
    const shapes=['square','circle','star'];
    for(let i=0;i<100;i++){
        setTimeout(()=>{
            const c=document.createElement('div');
            c.className='confetti '+shapes[Math.floor(Math.random()*shapes.length)];
            c.style.left=Math.random()*100+'%';
            c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
            c.style.animationDuration=(Math.random()*2+2)+'s';
            c.style.width=(Math.random()*8+6)+'px';
            c.style.height=c.style.width;
            document.body.appendChild(c);
            setTimeout(()=>c.remove(),4000);
        },i*30);
    }
}

function enter(type){myRoom=document.getElementById('rid').value.trim();if(!myRoom)return showToast("Sect ID Required");showLoading(true);const data={roomID:myRoom,playerName:myName,userID,equippedTitle:getEquippedTitleData(),level:getLevel()};if(type==='create'){data.maxPlayers=document.getElementById('maxp').value;currentMaxPlayers=parseInt(data.maxPlayers);isHost=true;}socket.emit(type==='create'?'createRoom':'joinRoom',data);}
function start(){const btn=document.getElementById('start-btn');if(btn.disabled)return;showLoading(true);socket.emit('startGame',myRoom);}
function closeRoom(){if(myRoom&&confirm("Disband this sect?"))socket.emit('requestCloseRoom',{roomID:myRoom});}
function sortHand(){const o={Spades:4,Hearts:3,Diamonds:2,Clubs:1};myCurrentHand.sort((a,b)=>(o[b.suit]-o[a.suit])||(b.val-a.val));renderHand();}
function answerSwap(accept){if(swapTimeoutId)clearTimeout(swapTimeoutId);document.getElementById('swap-modal').style.display='none';if(accept&&pendingSwapRequest)socket.emit('acceptSwap',{roomID:myRoom,fromUserID:pendingSwapRequest,myUserID:userID});pendingSwapRequest=null;}
function requestRematch(){if(rematchRequested)return;rematchRequested=true;document.getElementById('rematch-btn').innerText='‚úì READY';document.getElementById('rematch-btn').style.opacity='0.7';socket.emit('rematchReady',{roomID:myRoom,userID});}
socket.on('connect',()=>{document.getElementById('connection-status').innerHTML='üü¢ Connected';socket.emit('checkSession',{userID});});
socket.on('disconnect',()=>{document.getElementById('connection-status').innerHTML='üî¥ Disconnected';showToast("Connection lost...");});
socket.on('reconnectSuccess',d=>{myRoom=d.roomID;isFirstMove=d.isFirstMove||false;currentLeadSuit=d.currentSuit;if(d.players[0]?.userID===userID){isHost=true;document.getElementById('close-room-btn').style.display='block';}showLoading(false);document.getElementById('lobby').style.display='none';document.getElementById('room-tag').innerText="SECT: "+myRoom;showToast("Reconnected!",true);update(d);});
socket.on('roomList',list=>{const box=document.getElementById('room-box');box.innerHTML=list.length?"":'<div style="padding:15px;opacity:0.3">No active sects...</div>';list.forEach(r=>{const d=document.createElement('div');d.className=`room-item ${r.inGame?'in-game':''}`;d.innerHTML=`<span>#${r.id}</span><span>${r.count}/${r.max}${r.inGame?' üéÆ':''}</span>`;d.onclick=()=>{if(!r.inGame)document.getElementById('rid').value=r.id;};box.appendChild(d);});});
socket.on('updatePlayers',(p,roomData)=>{showLoading(false);document.getElementById('lobby').style.display='none';document.getElementById('room-tag').innerText="SECT: "+myRoom;isHost=p[0]?.userID===userID;document.getElementById('close-room-btn').style.display=isHost?'block':'none';
// Update start button with player count
const startBtn=document.getElementById('start-btn');
const maxP=roomData?.maxPlayers||currentMaxPlayers||p.length;
currentMaxPlayers=maxP;
const isFull=p.length>=maxP;
startBtn.style.display=isHost?'block':'none';
startBtn.innerText=`BEGIN DUEL (${p.length}/${maxP})`;
startBtn.disabled=!isFull;
startBtn.style.background=isFull?'var(--primary-action)':'rgba(100,116,139,0.8)';
startBtn.style.color=isFull?'#000':'rgba(255,255,255,0.7)';
startBtn.style.cursor=isFull?'pointer':'not-allowed';
startBtn.style.border=isFull?'none':'2px solid rgba(255,255,255,0.3)';
p.forEach(pl=>{if(pl.userID!==userID&&!stats.uniquePlayers.includes(pl.userID))stats.uniquePlayers.push(pl.userID);});saveStats();render(p,-1);});
socket.on('gameInit',d=>{showLoading(false);document.getElementById('round-popup').style.display='none';document.getElementById('gameover-modal').style.display='none';document.getElementById('start-btn').style.display='none';isProcessingTurn=false;isFirstMove=d.isFirstMove!==undefined?d.isFirstMove:true;currentLeadSuit=null;rematchRequested=false;const h=new Date().getHours();if(h>=0&&h<6){stats.nightGames=(stats.nightGames||0)+1;saveStats();}update(d);});
socket.on('clearTable',d=>{if(d.msg.toLowerCase()==='pangkah!'){flashScreen('pangkah');playSound('strike');if(d.winnerUserID===userID){stats.pangkahs=(stats.pangkahs||0)+1;addXP(3,"Pangkah!");}}else{flashScreen('clean');playSound('sweep');if(d.winnerUserID===userID)addXP(1,"Clean Round");}currentLeadSuit=null;const pop=document.getElementById('round-popup');document.getElementById('pop-title').className=d.msg==='Pangkah!'?'pangkah-text':'clean-text';document.getElementById('pop-title').innerText=d.msg.toUpperCase();document.getElementById('pop-desc').innerText=d.winner+" has the lead.";pop.style.display='block';setTimeout(()=>{pop.style.display='none';update(d);},2000);});
socket.on('updateTable',d=>{playSound('place');if(d.currentSuit)currentLeadSuit=d.currentSuit;if(d.table?.length>0)isFirstMove=false;stats.cardsPlayed=(stats.cardsPlayed||0)+1;saveStats();update(d);});
socket.on('nextTurn',d=>{if(d.currentSuit)currentLeadSuit=d.currentSuit;update(d);});
socket.on('errorMsg',m=>{showLoading(false);isProcessingTurn=false;showToast(m);});
socket.on('roomClosed',()=>{showToast("Sect disbanded");setTimeout(()=>location.reload(),2000);});
socket.on('rematchStatus',d=>{document.getElementById('rematch-status').innerText=`${d.readyCount}/${d.totalCount} players ready`;if(d.allReady)document.getElementById('rematch-status').innerText='Starting...';});
socket.on('gameOver',data=>{setTurnIndicator(false);stats.games=(stats.games||0)+1;const myPos=data.finishOrder.indexOf(userID)+1;if(myPos===1){stats.wins=(stats.wins||0)+1;stats.currentStreak=(stats.currentStreak||0)+1;if(stats.currentStreak>(stats.bestStreak||0))stats.bestStreak=stats.currentStreak;addXP(15+stats.currentStreak*2,`1st! Streak:${stats.currentStreak}`,false);launchConfetti();}else if(myPos===2){stats.secondPlace=(stats.secondPlace||0)+1;stats.topTwo=(stats.topTwo||0)+1;stats.currentStreak=0;addXP(8,"2nd Place",false);}else if(myPos===3){stats.thirdPlace=(stats.thirdPlace||0)+1;stats.currentStreak=0;addXP(5,"3rd Place",false);}else if(data.loserUserID===userID){stats.losses=(stats.losses||0)+1;stats.currentStreak=0;addXP(-2,"Defeated",false);}else{stats.currentStreak=0;addXP(3,`${myPos}th`,false);}if(myPos<=2)stats.topTwo=(stats.topTwo||0)+1;saveStats();checkAllTitles();updateStatsUI();document.getElementById('game-number').innerText=`Game #${data.gameNumber}`;document.getElementById('finish-list').innerHTML=data.performanceData.sort((a,b)=>a.position-b.position).map(p=>{const isW=p.position===1,isL=p.position===data.performanceData.length,isMe=p.userID===userID;let xp=isW?15:p.position===2?8:p.position===3?5:isL?-2:3;const tHtml=p.equippedTitle?`<span class="title-rarity ${p.equippedTitle.rarity}" style="font-size:8px;margin-left:5px">${p.equippedTitle.icon}</span>`:'';return`<div class="finish-item ${isW?'winner':''} ${isL?'loser':''}" style="${isMe?'border-width:2px':''}"><div style="font-size:18px;font-weight:800;width:30px">${isW?'üëë':isL?'üíÄ':'#'+p.position}</div><div style="flex:1;text-align:left;margin-left:10px;font-weight:600">${p.name}${tHtml}${isMe?' (You)':''}</div><div style="font-size:12px;color:var(--primary-action);font-weight:800">${xp>0?'+':''}${xp} XP</div></div>`;}).join('');const myData=data.performanceData.find(p=>p.userID===userID);let bonuses=[];if(myPos===1){bonuses.push({n:'üèÜ Victory',x:15});if(stats.currentStreak>1)bonuses.push({n:`üî• Streak x${stats.currentStreak}`,x:stats.currentStreak*2});}else if(myPos===2)bonuses.push({n:'ü•à 2nd',x:8});else if(myPos===3)bonuses.push({n:'ü•â 3rd',x:5});else if(data.loserUserID===userID)bonuses.push({n:'üíÄ Defeated',x:-2});if(myData?.stats?.pangkahsDealt)bonuses.push({n:`‚ö° Pangkahs (${myData.stats.pangkahsDealt})`,x:myData.stats.pangkahsDealt*3});if(myData?.stats?.cleanWins)bonuses.push({n:`‚ú® Clean (${myData.stats.cleanWins})`,x:myData.stats.cleanWins});const total=bonuses.reduce((s,b)=>s+b.x,0);document.getElementById('bonus-list').innerHTML=`<div style="font-weight:800;margin-bottom:10px;color:var(--gold)">üéÅ YOUR BONUSES</div>${bonuses.map(b=>`<div class="bonus-item"><span>${b.n}</span><span style="color:${b.x>=0?'var(--primary-action)':'var(--danger)'};font-weight:800">${b.x>0?'+':''}${b.x} XP</span></div>`).join('')}<div class="bonus-item" style="border-top:2px solid var(--gold);margin-top:10px;padding-top:10px"><span style="font-weight:800">TOTAL</span><span style="color:var(--gold);font-weight:800;font-size:16px">${total>0?'+':''}${total} XP</span></div>`;document.getElementById('rematch-btn').innerText='‚ö° REMATCH';document.getElementById('rematch-btn').style.opacity='1';document.getElementById('rematch-status').innerText='Waiting...';rematchRequested=false;document.getElementById('gameover-modal').style.display='flex';});
socket.on('receiveSwapRequest',d=>{pendingSwapRequest=d.fromUserID;document.getElementById('swap-txt').innerText=d.fromName+" wants your hand!";document.getElementById('swap-modal').style.display='block';let t=15;const timer=document.getElementById('swap-timer');timer.innerText=`${t}s`;const cd=setInterval(()=>{t--;timer.innerText=`${t}s`;if(t<=0)clearInterval(cd);},1000);swapTimeoutId=setTimeout(()=>{clearInterval(cd);if(pendingSwapRequest===d.fromUserID){answerSwap(false);showToast("Swap expired");}},15000);});
socket.on('swapOccurred',d=>{playSound('absorb');showToast(d.msg,true);if(d.requesterUserID===userID){stats.handsAbsorbed=(stats.handsAbsorbed||0)+1;addXP(5,"Hand Absorbed!");}if(d.accepterUserID===userID)addXP(3,"Hand Given!");saveStats();checkAllTitles();update(d);});

// Turn Timer
socket.on('turnTimer',d=>{
    const timerEl=document.getElementById('turn-timer');
    if(d.timeLeft>0){
        timerEl.innerText=`(${d.timeLeft}s)`;
        timerEl.style.color=d.timeLeft<=5?'var(--danger)':'inherit';
    }else{
        timerEl.innerText='';
    }
});

// Auto-play - includes full game state for proper render
socket.on('autoPlayed',d=>{
    showToast(`‚è±Ô∏è ${d.playerName} auto-played: ${d.card.rank}${icons[d.card.suit]}`,false);
    playSound('place');
    if(d.currentSuit)currentLeadSuit=d.currentSuit;
    if(d.table?.length>0)isFirstMove=false;
    update(d);
});

function update(d){isProcessingTurn=false;showLoading(false);const me=d.players.find(p=>p.userID===userID);if(me)myCurrentHand=me.hand;const active=d.players[d.turn];const isMyTurn=active?.userID===userID;setTurnIndicator(isMyTurn);const sInd=document.getElementById('suit-indicator');if(d.table?.length>0){sInd.style.display='flex';currentLeadSuit=d.table[0].card.suit;document.getElementById('suit-symbol').innerText=icons[currentLeadSuit];document.getElementById('suit-symbol').style.color=['Hearts','Diamonds'].includes(currentLeadSuit)?'var(--danger)':'white';}else{sInd.style.display='none';currentLeadSuit=null;}render(d.players,d.turn,d.table||[]);if(d.fateAces)showFateInHeader(d.fateAces);}

// 2-Row Layout Configuration
function getRowConfig(playerCount){
    const configs={4:[2,2],5:[3,2],6:[3,3],7:[4,3],8:[4,4],10:[5,5]};
    return configs[playerCount]||[Math.ceil(playerCount/2),Math.floor(playerCount/2)];
}

function render(players,turn,table=[]){
    const pLayer=document.getElementById('p-layer');
    pLayer.innerHTML="";
    const myIdx=players.findIndex(p=>p.userID===userID);
    const [topCount,bottomCount]=getRowConfig(players.length);
    const gameArea=document.getElementById('game-view');
    const areaWidth=gameArea.offsetWidth;
    const areaHeight=gameArea.offsetHeight;
    
    // Calculate positions
    const avatarWidth=205;
    const topY=20;
    const bottomY=areaHeight-90;
    
    players.forEach((p,i)=>{
        let x,y;
        if(i<topCount){
            // Top row - left to right
            const spacing=areaWidth/(topCount+1);
            x=spacing*(i+1);
            y=topY;
        }else{
            // Bottom row - left to right (reversed order visually for clockwise)
            const bottomIdx=i-topCount;
            const spacing=areaWidth/(bottomCount+1);
            x=spacing*(bottomCount-bottomIdx);
            y=bottomY;
        }
        
        // Check if this player is next for swap
        let canSwap=false;
        let canSwapGreyed=false;
        const isMyTurn=turn===myIdx;
        if(players.length>1&&i!==myIdx&&p.hand.length>0){
            let nxt=(myIdx+1)%players.length,att=0;
            while(players[nxt].hand.length===0&&att<players.length){nxt=(nxt+1)%players.length;att++;}
            if(i===nxt&&att<players.length){
                if(isMyTurn){
                    canSwap=true;
                }else{
                    canSwapGreyed=true;
                }
            }
        }
        
        const playerLevel=p.level||1;
        const titleText=p.equippedTitle?`${p.equippedTitle.name}`:'';
        
        const div=document.createElement('div');
        div.className=`player ${i===turn?'active':''} ${p.hand.length===0?'eliminated':''}`;
        div.style.position='absolute';
        div.style.left=`${x}px`;
        div.style.top=`${y}px`;
        div.style.transform='translateX(-50%)';
        const thClass=canSwap?'visible':canSwapGreyed?'visible greyed':'';
        div.innerHTML=`<div class="av">
<div class="av-take-hand ${thClass}" onclick="event.stopPropagation();socket.emit('sendSwapRequest',{roomID:'${myRoom}',fromUserID:'${userID}'})" title="Take Hand"></div>
<div class="av-avatar"></div>
<div class="av-info">
<div class="av-level">LVL ${playerLevel}</div>
<div class="av-name" style="color:${p.userID===userID?'var(--ui-blue)':'#fff'}">${p.name}</div>
<div class="av-title">${titleText}</div>
</div>
<div class="av-cards">${p.hand.length}</div>
</div>`;
        pLayer.appendChild(div);
    });
    
    renderHand();
    
    // Render table cards
    const tLayer=document.getElementById('t-layer');
    tLayer.innerHTML="";
    if(table.length>0){
        const rowDiv=document.createElement('div');
        rowDiv.className='table-cards-row';
        table.forEach((tc)=>{
            const el=createCardUI(tc.card);
            el.className=`card table-card ${['Hearts','Diamonds'].includes(tc.card.suit)?'red':''}`;
            rowDiv.appendChild(el);
        });
        tLayer.appendChild(rowDiv);
    }
}

// Show Fate aces in header instead of game area
function showFateInHeader(list){
    const fateEl=document.getElementById('fate-display');
    if(!list||list.length===0){
        fateEl.style.display='none';
        return;
    }
    fateEl.style.display='flex';
    const isBlack=s=>['Spades','Clubs'].includes(s);
    fateEl.innerHTML=`<span style="color:var(--gold);margin-right:5px">‚ö∞Ô∏è</span>`+list.map(c=>`<span style="color:${isBlack(c.suit)?'#fff':'var(--danger)'};font-weight:800;margin:0 2px">A${icons[c.suit]}</span>`).join('');
}

function renderHand(){const hDiv=document.getElementById('my-cards');hDiv.innerHTML="";const isMyTurn=document.getElementById('turn-glow').classList.contains('active');const hasLead=currentLeadSuit&&myCurrentHand.some(c=>c.suit===currentLeadSuit);myCurrentHand.forEach(c=>{const el=createCardUI(c);let canPlay=true,highlight=false;if(!isMyTurn||isProcessingTurn)canPlay=false;else if(isFirstMove){canPlay=c.suit==='Spades'&&c.rank==='K';highlight=canPlay;}else if(currentLeadSuit&&hasLead){canPlay=c.suit===currentLeadSuit;highlight=canPlay;}else highlight=isMyTurn;if(!canPlay)el.classList.add('disabled');else if(highlight)el.classList.add('highlight');el.onclick=e=>{if(!isProcessingTurn&&isMyTurn&&canPlay){e.currentTarget.classList.add('disabled');e.currentTarget.classList.remove('highlight');isProcessingTurn=true;showLoading(true);socket.emit('playCard',{roomID:myRoom,cardObject:c});}};hDiv.appendChild(el);});}
function createCardUI(c){const d=document.createElement('div');d.className=`card ${['Hearts','Diamonds'].includes(c.suit)?'red':''}`;d.innerHTML=`<div style="font-size:10px">${c.rank}</div><div style="font-size:28px;text-align:center">${icons[c.suit]}</div><div style="font-size:10px;transform:rotate(180deg)">${c.rank}</div>`;return d;}
function showDiscarded(list){showFateInHeader(list);}
updateStatsUI();checkAllTitles();
window.addEventListener('beforeunload',e=>{if(myRoom&&document.getElementById('lobby').style.display==='none'){e.preventDefault();e.returnValue='';}});
</script>
</body>
</html>
