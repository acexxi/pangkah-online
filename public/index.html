<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pangkah Pro Online</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0e3d2a; color: white; text-align: center; margin: 0; }
        .container { max-width: 800px; margin: auto; padding: 20px; }
        
        /* UI Kad Terup */
        .card { 
            background: white; color: black; width: 60px; height: 90px; 
            border-radius: 8px; display: inline-flex; flex-direction: column; 
            justify-content: space-between; padding: 5px; margin: 5px; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer;
            position: relative; font-weight: bold; font-size: 1.2em;
            border: 1px solid #ccc;
        }
        .card.red { color: #d32f2f; }
        .card .suit-big { font-size: 2em; align-self: center; }
        .card:hover { transform: translateY(-10px); background: #f0f0f0; }

        #table { 
            background: rgba(0,0,0,0.2); border: 3px solid #1e5e41; 
            border-radius: 50%; min-height: 250px; margin: 20px 0; 
            display: flex; align-items: center; justify-content: center; flex-wrap: wrap;
        }

        #status-bar { background: #f39c12; padding: 10px; font-weight: bold; border-radius: 5px; margin-bottom: 10px; }
        .active-turn { background: #2ecc71 !important; border: 2px solid white; }

        .player-info { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .player-card { background: #2c3e50; padding: 10px; border-radius: 5px; min-width: 100px; }
        .current { border: 2px solid #f1c40f; color: #f1c40f; }
    </style>
</head>
<body>

<div id="lobby" class="container">
    <h1>üÉè PANGKAH PRO</h1>
    <input type="text" id="pName" placeholder="Nama Anda" style="padding:10px; width:80%"><br><br>
    <input type="text" id="rID" placeholder="ID Bilik" style="padding:10px; width:80%"><br><br>
    <select id="mP" style="padding:10px; width:85%">
        <option value="4">4 Orang</option><option value="5">5 Orang</option><option value="6">6 Orang</option>
    </select><br><br>
    <button onclick="join(true)" style="padding:10px 40px; background:#27ae60; color:white; border:none; cursor:pointer">Cipta Bilik</button>
    <button onclick="join(false)" style="padding:10px 40px; background:#2980b9; color:white; border:none; cursor:pointer">Sertai Bilik</button>
</div>

<div id="gameArea" class="container" style="display:none;">
    <div id="status-bar">Menunggu Pemain...</div>
    <div id="playerList" class="player-info"></div>
    
    <div id="table">
        <div id="tableCards"></div>
    </div>
    
    <div id="handArea">
        <h3>Kad Anda (Disusun)</h3>
        <div id="myHand"></div>
    </div>
    <br>
    <button id="startBtn" onclick="start()" style="display:none; padding:15px; background:#e67e22; color:white; border:none; width:100%">MULA PERMAINAN</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myRoom = "", myId = "";

    const suitIcons = { 'Spades': '‚ô†', 'Hearts': '‚ô•', 'Diamonds': '‚ô¶', 'Clubs': '‚ô£' };
    const suitOrder = { 'Spades': 4, 'Hearts': 3, 'Diamonds': 2, 'Clubs': 1 };

    function join(isCreate) {
        const name = document.getElementById('pName').value;
        const room = document.getElementById('rID').value;
        const max = document.getElementById('mP').value;
        if(!name || !room) return alert("Lengkapkan maklumat!");
        myRoom = room;
        socket.emit(isCreate ? 'createRoom' : 'joinRoom', { roomID: room, playerName: name, maxPlayers: max });
    }

    function start() { socket.emit('startGame', myRoom); }

    socket.on('updatePlayers', (p) => {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        if(p.length >= 4) document.getElementById('startBtn').style.display = 'block';
        renderPlayers(p, -1);
    });

    socket.on('gameInit', d => {
        document.getElementById('startBtn').style.display = 'none';
        renderUI(d.players, d.turn);
    });

    socket.on('updateTable', d => renderUI(d.players, d.turn, d.table));
    
    socket.on('clearTable', d => {
        alert("Pemenang pusingan: " + d.winner);
        document.getElementById('tableCards').innerHTML = "";
        renderUI(d.players, d.turn);
    });

    socket.on('gameOver', d => {
        alert("PERMAINAN TAMAT! Pemain terakhir: " + d.loser);
        location.reload();
    });

    function renderUI(players, turn, table = []) {
        renderPlayers(players, turn);
        const me = players.find(p => p.id === socket.id);
        const hDiv = document.getElementById('myHand');
        hDiv.innerHTML = "";
        
        if(me) {
            // SUSUN KAD: Daun (Spades > Hearts > Diamonds > Clubs) kemudian Nilai (A > K > Q...)
            me.hand.sort((a, b) => {
                if (suitOrder[b.suit] !== suitOrder[a.suit]) return suitOrder[b.suit] - suitOrder[a.suit];
                return b.val - a.val;
            });

            me.hand.forEach((c, i) => {
                hDiv.appendChild(createCardUI(c, () => {
                    if(players[turn].id === socket.id) socket.emit('playCard', { roomID: myRoom, cardIndex: i });
                }));
            });
        }

        const tDiv = document.getElementById('tableCards');
        tDiv.innerHTML = "";
        table.forEach(tc => {
            let cUI = createCardUI(tc.card);
            cUI.innerHTML += `<small style="display:block; color:white; background:black">${tc.playerName}</small>`;
            tDiv.appendChild(cUI);
        });
    }

    function createCardUI(card, onClick) {
        const div = document.createElement('div');
        div.className = 'card' + (card.suit === 'Hearts' || card.suit === 'Diamonds' ? ' red' : '');
        div.innerHTML = `<div>${card.rank}</div><div class="suit-big">${suitIcons[card.suit]}</div><div style="text-align:right">${card.rank}</div>`;
        if(onClick) div.onclick = onClick;
        return div;
    }

    function renderPlayers(players, turn) {
        const list = document.getElementById('playerList');
        list.innerHTML = "";
        players.forEach((p, i) => {
            list.innerHTML += `<div class="player-card ${i===turn?'current':''}">
                ${p.name}<br><small>Kad: ${p.hand.length}</small>
            </div>`;
        });
        if(turn !== -1) {
            const status = document.getElementById('status-bar');
            status.innerText = players[turn].id === socket.id ? "GILIRAN ANDA!" : "Giliran " + players[turn].name;
            status.className = players[turn].id === socket.id ? "active-turn" : "";
        }
    }

    socket.on('errorMsg', m => alert(m));
</script>
</body>
</html>
