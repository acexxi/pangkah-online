<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pangkah Murim</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-primary: rgba(20, 20, 28, 0.88);
            --bg-secondary: rgba(30, 30, 42, 0.75);
            --bg-tertiary: rgba(45, 45, 60, 0.5);
            --bg-hover: rgba(255, 255, 255, 0.06);
            --accent-blue: #60a5fa;
            --accent-green: #34d399;
            --accent-purple: #a78bfa;
            --accent-pink: #f472b6;
            --accent-orange: #fb923c;
            --accent-red: #f87171;
            --accent-gold: #fbbf24;
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            --text-muted: rgba(255, 255, 255, 0.35);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.12);
            --border-medium: rgba(255, 255, 255, 0.18);
            --gradient-blue: linear-gradient(135deg, #60a5fa, #3b82f6);
            --gradient-green: linear-gradient(135deg, #34d399, #10b981);
            --gradient-gold: linear-gradient(135deg, #fbbf24, #f59e0b);
            --gradient-purple: linear-gradient(135deg, #a78bfa, #8b5cf6);
            --legendary: linear-gradient(135deg, #fbbf24, #f59e0b);
            --epic: linear-gradient(135deg, #a78bfa, #8b5cf6);
            --rare: linear-gradient(135deg, #60a5fa, #3b82f6);
            --common: linear-gradient(135deg, #9ca3af, #6b7280);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.25);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.3);
            --primary-action: #34d399;
            --ui-blue: #60a5fa;
            --danger: #f87171;
            --gold: #fbbf24;
            --purple: #a78bfa;
            --glass: rgba(255,255,255,0.06);
            --glass-heavy: rgba(20, 20, 28, 0.88);
            --glass-light: rgba(255,255,255,0.08);
            --border: rgba(255,255,255,0.12);
            --border-light: rgba(255,255,255,0.15);
            --table-bg: url('/murim.jpg');
        }
        * { box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; }
        body { margin: 0; height: 100vh; overflow: hidden; background: var(--table-bg) center/cover no-repeat fixed; color: var(--text-primary); display: flex; flex-direction: column; font-size: 14px; line-height: 1.5; }
        #lobby { position: fixed; inset: 0; z-index: 5000; backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%); background: rgba(0, 0, 0, 0.4); display: flex; flex-direction: column; height: 100vh; }
        .panel { width: 90%; max-width: 380px; padding: 28px; border-radius: 20px; background: var(--bg-primary); border: 1px solid var(--border-light); backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%); text-align: center; box-shadow: var(--shadow-xl); }
        .lobby-header { position: fixed; top: 0; left: 0; right: 0; height: 56px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: var(--bg-primary); backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%); border-bottom: 1px solid var(--border-subtle); z-index: 1000; }
        .lobby-header-left { display: flex; align-items: center; }
        .header-logo { height: 26px; width: auto; opacity: 0.95; }
        .lobby-header-right { display: flex; align-items: center; gap: 8px; }
        .header-btn { width: 36px; height: 36px; border-radius: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .header-btn:hover { background: var(--bg-hover); border-color: var(--border-light); transform: translateY(-1px); }
        .header-btn img { opacity: 0.8; transition: opacity 0.2s; }
        .header-btn:hover img { opacity: 1; }
        .header-btn.hamburger-btn { display: none; border-radius: 10px; }
        .header-menu { position: fixed; top: 62px; right: 12px; z-index: 7000; display: none; flex-direction: column; min-width: 220px; border-radius: 14px; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-light); backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%); box-shadow: var(--shadow-xl); }
        .header-menu.open { display: flex; }
        .header-menu-card { padding: 12px; border-bottom: 1px solid var(--border-subtle); }
        .header-menu-namecard { width: 100%; display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 12px; background: var(--bg-tertiary); }
        .header-badge { width: 36px; height: 36px; }
        .header-player-info { display: flex; flex-direction: column; gap: 2px; }
        .header-name { color: var(--accent-blue); font-weight: 600; font-size: 13px; }
        .header-title { font-size: 11px; color: var(--text-tertiary); }
        .header-menu-item { width: 100%; padding: 12px 14px; border-radius: 10px; background: transparent; border: 0; text-align: left; color: var(--text-primary); font-weight: 500; font-size: 13px; cursor: pointer; display: flex; align-items: center; transition: background 0.15s; }
        .header-menu-item:hover { background: var(--bg-hover); }
        @media (max-width: 520px) { .lobby-header-right .profile-btn, .lobby-header-right .leaderboard-btn, .lobby-header-right .gm-admin-header-btn { display: none !important; } .lobby-header-right .header-btn.hamburger-btn { display: flex; } .lobby-header { padding: 0 16px; } }
        .lobby-body { flex: 1; display: flex; align-items: center; justify-content: center; padding-top: 56px; }
        .room-list { height: 140px; overflow-y: auto; background: var(--bg-tertiary); border-radius: 12px; margin: 16px 0; border: 1px solid var(--border-subtle); }
        .room-item { padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 13px; font-weight: 500; transition: background 0.15s; }
        .room-item:hover { background: var(--bg-hover); }
        .room-item:last-child { border-bottom: none; }
        .room-item.in-game { opacity: 0.5; }
        input, select { width: 100%; padding: 12px 16px; margin-bottom: 10px; border-radius: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-subtle); outline: none; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        input::placeholder { color: var(--text-muted); }
        input:focus, select:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); }
        select option { background: #1e1e2a; color: var(--text-primary); }
        .btn { padding: 12px 20px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; width: 100%; border: none; transition: all 0.2s ease; }
        .btn-p { background: var(--gradient-blue); color: #fff; box-shadow: 0 2px 8px rgba(96, 165, 250, 0.3); }
        .btn-p:hover { box-shadow: 0 4px 16px rgba(96, 165, 250, 0.4); transform: translateY(-1px); }
        .btn-s { background: var(--bg-tertiary); border: 1px solid var(--border-light); color: var(--text-primary); }
        .btn-s:hover { background: var(--bg-hover); }
        .btn-gold { background: var(--gradient-gold); color: #000; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); }
        .btn-gold:hover { box-shadow: 0 4px 16px rgba(251, 191, 36, 0.4); transform: translateY(-1px); }
        .modal-overlay { position: fixed; inset: 0; z-index: 6000; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: none; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        #profile-modal .profile-card, #titles-modal .titles-card { width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; padding: 28px 24px; background: var(--bg-primary); border-radius: 20px; text-align: center; backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); box-shadow: var(--shadow-xl); border: 1px solid var(--border-light); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .stat-box { background: var(--bg-tertiary); padding: 16px 12px; border-radius: 12px; border: 1px solid var(--border-subtle); }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--accent-blue); }
        .stat-label { font-size: 10px; color: var(--text-tertiary); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .bar-container { width: 100%; height: 6px; background: var(--bg-tertiary); border-radius: 3px; margin: 12px 0; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--gradient-blue); border-radius: 3px; transition: width 0.6s ease; }
        .title-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; min-height: 240px; }
        .title-item { padding: 14px; border-radius: 12px; border: 1px solid var(--border-subtle); background: var(--bg-tertiary); cursor: pointer; transition: all 0.2s; text-align: left; position: relative; }
        .title-item:hover { background: var(--bg-hover); transform: translateY(-2px); }
        .title-item.locked { opacity: 0.4; cursor: not-allowed; }
        .title-item.equipped { border-color: var(--accent-gold); box-shadow: 0 0 16px rgba(251, 191, 36, 0.2); }
        .title-name { font-weight: 600; font-size: 12px; margin-bottom: 4px; color: var(--text-primary); }
        .title-desc { font-size: 10px; color: var(--text-tertiary); line-height: 1.4; }
        .title-progress { font-size: 10px; color: var(--accent-blue); margin-top: 6px; }
        .title-rarity { font-size: 9px; font-weight: 700; padding: 3px 8px; border-radius: 6px; display: inline-block; margin-bottom: 8px; letter-spacing: 0.3px; }
        .title-rarity.legendary { background: var(--legendary); color: #000; }
        .title-rarity.epic { background: var(--epic); color: #fff; }
        .title-rarity.rare { background: var(--rare); color: #fff; }
        .title-rarity.common { background: var(--common); color: #fff; }
        .title-rarity.special { background: linear-gradient(90deg, #f472b6, #fbbf24, #34d399); color: #000; font-weight: 800; }
        .title-item.special-title { border-color: #f472b6; background: linear-gradient(135deg, rgba(244, 114, 182, 0.15), rgba(251, 191, 36, 0.1), rgba(52, 211, 153, 0.08)); animation: specialGlow 3s ease-in-out infinite; }
        @keyframes specialGlow { 0%, 100% { box-shadow: 0 0 10px rgba(244, 114, 182, 0.3); } 50% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); } }
        .title-item.gm-title { border-color: var(--accent-pink); background: linear-gradient(135deg, rgba(244, 114, 182, 0.15), rgba(251, 191, 36, 0.08)); }
        .title-item.gm-title .title-rarity { background: linear-gradient(90deg, #f472b6, #fbbf24); color: #000; }
        .title-item.beta-title { border-color: var(--accent-green); background: linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(96, 165, 250, 0.08)); }
        .title-item.beta-title .title-rarity { background: linear-gradient(90deg, #34d399, #60a5fa); color: #fff; }
        .filter-tabs { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; justify-content: center; }
        .filter-tab { padding: 8px 14px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; border: 1px solid var(--border-subtle); background: var(--bg-tertiary); color: var(--text-secondary); transition: all 0.15s; }
        .filter-tab:hover { background: var(--bg-hover); }
        .filter-tab.active { background: var(--accent-blue); border-color: var(--accent-blue); color: #fff; }
        .leaderboard-card { background: var(--bg-primary); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border: 1px solid var(--border-light); padding: 24px; border-radius: 20px; width: 95%; max-width: 800px; max-height: 85vh; text-align: center; box-shadow: var(--shadow-xl); overflow-y: auto; }
        .leaderboard-filters { margin-bottom: 16px; }
        .leaderboard-filters select { width: auto; padding: 10px 16px; font-size: 13px; }
        .leaderboard-table-wrapper { overflow-x: auto; max-height: 420px; overflow-y: auto; border-radius: 12px; }
        .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .leaderboard-table th { background: var(--bg-tertiary); color: var(--accent-gold); padding: 12px 8px; text-align: center; position: sticky; top: 0; z-index: 1; font-size: 10px; font-weight: 600; letter-spacing: 0.3px; }
        .leaderboard-table td { padding: 10px 8px; border-bottom: 1px solid var(--border-subtle); text-align: center; }
        .leaderboard-table tr:hover { background: var(--bg-hover); }
        .leaderboard-table tr:nth-child(1) td { background: rgba(251, 191, 36, 0.1); }
        .leaderboard-table tr:nth-child(2) td { background: rgba(192, 192, 192, 0.08); }
        .leaderboard-table tr:nth-child(3) td { background: rgba(205, 127, 50, 0.08); }
        .lb-rank { font-weight: 700; }
        .lb-name { font-weight: 600; color: var(--accent-blue); text-align: left !important; }
        .hof-container { margin-bottom: 20px; }
        .hof-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .hof-card { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 16px; text-align: left; transition: all 0.2s; }
        .hof-card:hover { background: var(--bg-hover); border-color: var(--accent-gold); transform: translateY(-2px); }
        .hof-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .hof-icon { font-size: 24px; }
        .hof-card-title { font-size: 11px; font-weight: 700; color: var(--accent-gold); letter-spacing: 0.3px; }
        .hof-player { font-size: 14px; font-weight: 600; color: var(--accent-blue); }
        .hof-value { font-size: 12px; color: var(--accent-green); font-weight: 600; }
        .hof-desc { font-size: 11px; color: var(--text-tertiary); line-height: 1.5; margin-top: 8px; }
        .hof-btn { background: var(--bg-tertiary); border: 1px solid var(--border-light); color: var(--text-primary); padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .hof-btn:hover { background: var(--bg-hover); }
        #gameover-modal { position: fixed; inset: 0; z-index: 10000; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: none; align-items: center; justify-content: center; padding: 20px; }
        .gameover-card { width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; padding: 28px 24px; background: var(--bg-primary); border-radius: 20px; text-align: center; backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); box-shadow: var(--shadow-xl); border: 1px solid var(--accent-red); }
        .finish-list { margin: 20px 0; }
        .finish-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; margin: 8px 0; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border-subtle); }
        .finish-item.winner { border-color: var(--accent-gold); background: rgba(251, 191, 36, 0.08); }
        .finish-item.loser { border-color: var(--accent-red); background: rgba(248, 113, 113, 0.08); }
        .bonus-list { background: var(--bg-tertiary); border-radius: 14px; padding: 16px; margin: 16px 0; text-align: left; border: 1px solid var(--border-subtle); }
        .bonus-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); font-size: 13px; }
        .bonus-item:last-child { border-bottom: none; }

        #swap-modal { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-primary); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); padding: 28px; border-radius: 20px; border: 1px solid var(--accent-orange); z-index: 10001; display: none; text-align: center; width: 90%; max-width: 320px; box-shadow: var(--shadow-xl); }
        #round-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-primary); border: 1px solid var(--border-light); padding: 40px 50px; border-radius: 20px; text-align: center; z-index: 9999; display: none; min-width: 280px; backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); box-shadow: var(--shadow-xl); }
        .pangkah-text { color: var(--accent-red); font-size: 2rem; font-weight: 800; text-shadow: 0 0 20px var(--accent-red); }
        .clean-text { color: var(--accent-blue); font-size: 2rem; font-weight: 800; text-shadow: 0 0 20px var(--accent-blue); }
        #achievement-popup { position: fixed; top: 100px; right: 20px; background: var(--bg-primary); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); padding: 20px; border-radius: 16px; border: 1px solid var(--accent-gold); z-index: 10002; display: none; min-width: 280px; animation: slideIn 0.4s ease; box-shadow: var(--shadow-lg); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        /* GM Admin Styles */
        .gm-stat-input { width: 100%; background: transparent; border: none; color: #fff; font-size: 16px; font-weight: 700; padding: 5px 0; outline: none; }
        .gm-stat-input:focus { border-bottom: 2px solid var(--accent-gold); }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); transition: 0.3s; border-radius: 26px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: #fff; transition: 0.3s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background-color: #22c55e; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .header { height: 60px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-subtle); background: var(--bg-primary); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); }
        #game-view { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .safe-wrap { position: relative; width: 100%; height: 100%; }
        #t-layer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; pointer-events: none; }
        .player { position: absolute; text-align: center; z-index: 100; transition: all 0.3s ease; }
        .av { position: relative; width: 205px; height: 70px; background: url('/frame/avatar-frame.png') center/contain no-repeat; display: flex; align-items: center; }
        .av.frame-winrate { background-image: url('/frame/frame-winrate.png'); }
        .av.frame-streak { background-image: url('/frame/frame-streak.png'); }
        .av.frame-pangkah { background-image: url('/frame/frame-pangkah.png'); }
        .av.frame-loserate { background-image: url('/frame/frame-loserate.png'); }
        .av.frame-magnet { background-image: url('/frame/frame-magnet.png'); }
        .av.frame-gm { background-image: url('/frame/frame-gm.png'); }
        .av-take-hand { position: absolute; left: 0px; top: 50%; transform: translateY(-50%); width: 36px; height: 55px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.2s; border-radius: 4px; }
        .av-take-hand.visible { opacity: 1; pointer-events: auto; }
        .av-take-hand.visible.greyed { opacity: 0.5; cursor: not-allowed; }
        .av-take-hand.visible.greyed::after { color: #6b7280; text-shadow: none; }
        .av-take-hand.visible.greyed:hover { background: transparent; }
        .av-take-hand:hover { background: rgba(52, 211, 153, 0.3); }
        .av-take-hand::after { content: 'TH'; font-size: 12px; font-weight: 800; color: var(--accent-green); text-shadow: 0 0 8px var(--accent-green), 0 1px 2px rgba(0,0,0,0.8); }
        .av-avatar { position: absolute; left: 42px; top: 50%; transform: translateY(-50%); width: 52px; height: 52px; border-radius: 8px; background: transparent; overflow: hidden; }
        .av-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .av-info { position: absolute; left: 100px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: flex-start; justify-content: center; gap: 1px; width: 70px; }
        .av-level { font-size: 8px; font-weight: 700; color: var(--accent-green); text-transform: uppercase; line-height: 1.2; }
        .av-name { font-size: 11px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65px; line-height: 1.3; }
        .av-title { font-size: 8px; font-weight: 500; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65px; line-height: 1.2; }
        .av-cards { position: absolute; right: -2px; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: 800; color: var(--accent-orange); text-shadow: 0 0 8px var(--accent-orange), 0 1px 2px rgba(0,0,0,0.8); width: 36px; text-align: center; }
        .active .av { filter: drop-shadow(0 0 12px var(--accent-green)); }
        .player.eliminated .av { opacity: 0.3; filter: grayscale(1); }
        #hand-area { height: 28vh; background: var(--bg-primary); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border-top: 1px solid var(--border-subtle); padding: 16px; overflow-y: auto; z-index: 2000; }
        .hand-header { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 12px; }
        #turn-indicator-inline { background: var(--gradient-green); color: #000; font-size: 12px; font-weight: 700; padding: 8px 16px; border-radius: 20px; display: none; animation: pulse-glow 1.5s infinite; }
        #turn-indicator-inline.active { display: flex; align-items: center; gap: 6px; }
        #turn-timer { font-weight: 800; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 8px var(--accent-green); } 50% { box-shadow: 0 0 20px var(--accent-green); } }
        .hand-flex { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; padding-bottom: 20px; }
        .card { width: 52px; height: 78px; background: rgba(255, 255, 255, 0.97); color: #1a1a2e; border-radius: 10px; padding: 6px; font-weight: 700; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.3); transition: transform 0.15s, box-shadow 0.15s; box-shadow: var(--shadow-md); }
        .card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); }
        .card.red { color: var(--accent-red) !important; }
        .card.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .card.highlight { border: 2px solid var(--accent-green); box-shadow: 0 0 12px var(--accent-green); }
        .table-card { position: relative; top: auto; left: auto; transform: none; width: 60px; height: 90px; border: 2px solid rgba(255, 255, 255, 0.5); box-shadow: var(--shadow-lg); pointer-events: none; animation: cardDrop 0.4s ease; flex-shrink: 0; border-radius: 10px; }
        .table-cards-row { display: flex; gap: 8px; padding: 16px 20px; background: var(--bg-secondary); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; border: 1px solid var(--border-subtle); }
        @keyframes cardDrop { from { transform: translateY(-30px) scale(0.8); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        #streak-indicator { position: fixed; top: 80px; left: 20px; background: var(--bg-primary); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); padding: 12px 16px; border-radius: 14px; border: 1px solid var(--accent-gold); display: none; z-index: 100; box-shadow: var(--shadow-md); }
        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--accent-red); padding: 12px 24px; border-radius: 10px; z-index: 10003; display: none; font-weight: 600; font-size: 13px; }
        #discard-area { position: absolute; left: 15px; top: 85px; display: flex; flex-direction: row; gap: 8px; z-index: 10; align-items: flex-start; flex-wrap: wrap; max-width: 200px; background: var(--bg-primary); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); padding: 14px; border-radius: 14px; border: 1px solid var(--border-subtle); }
        .fate-label { font-size: 10px; color: var(--accent-gold); width: 100%; margin-bottom: 6px; font-weight: 600; letter-spacing: 0.3px; }
        .fate-card { width: 45px; height: 65px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; font-size: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; box-shadow: var(--shadow-md); border: 2px solid var(--accent-gold); }
        .fate-card.black { color: #1a1a2e; }
        .fate-card.red { color: var(--accent-red); }
        #turn-glow { position: fixed; inset: 0; pointer-events: none; z-index: 9000; opacity: 0; transition: opacity 0.3s; }
        #turn-glow.active { opacity: 1; }
        #turn-glow::before { content: ''; position: absolute; inset: 0; border: 3px solid var(--accent-green); box-shadow: inset 0 0 50px var(--accent-green), 0 0 25px var(--accent-green); animation: glowPulse 1.5s ease-in-out infinite; }
        @keyframes glowPulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .howtoplay-card { width: 90%; max-width: 440px; max-height: 85vh; overflow-y: auto; padding: 24px; border-radius: 20px; background: var(--bg-primary); border: 1px solid var(--border-light); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); text-align: center; }
        .guide-section { background: var(--bg-tertiary); border-radius: 12px; padding: 14px 16px; margin-bottom: 12px; text-align: left; }
        .guide-title { color: var(--accent-green); font-weight: 700; font-size: 12px; margin-bottom: 10px; letter-spacing: 0.5px; }
        .guide-section p { font-size: 13px; margin: 0; line-height: 1.6; color: var(--text-secondary); }
        .guide-step { display: flex; align-items: flex-start; gap: 12px; font-size: 13px; margin: 10px 0; color: var(--text-secondary); line-height: 1.5; }
        .step-num { width: 24px; height: 24px; background: var(--gradient-green); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0; }
        .pangkah-box { background: rgba(248, 113, 113, 0.1); border: 1px solid var(--accent-red); border-radius: 10px; padding: 12px; margin-top: 10px; font-size: 12px; color: var(--text-secondary); }
        .pangkah-box div { margin: 5px 0; }
        #emote-bar { display: flex; gap: 6px; background: var(--bg-tertiary); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 6px 10px; border-radius: 20px; border: 1px solid var(--border-subtle); }
        .emote-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-hover); border: 1px solid var(--border-subtle); font-size: 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .emote-btn:hover { transform: scale(1.15); background: var(--bg-secondary); }
        .emote-btn:active { transform: scale(0.95); }
        .emote-float { position: fixed; font-size: 48px; pointer-events: none; z-index: 10005; animation: emoteFloat 2s ease forwards; }
        @keyframes emoteFloat { 0% { opacity: 1; transform: scale(0.5) translateY(0); } 20% { transform: scale(1.2) translateY(-20px); } 100% { opacity: 0; transform: scale(1) translateY(-150px); } }
        .emote-from { position: absolute; background: var(--bg-primary); padding: 4px 10px; border-radius: 8px; font-size: 10px; white-space: nowrap; bottom: -22px; left: 50%; transform: translateX(-50%); }
        .confetti { position: fixed; width: 10px; height: 10px; top: -10px; z-index: 10006; pointer-events: none; animation: confettiFall linear forwards; }
        @keyframes confettiFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .confetti.square { border-radius: 2px; }
        .confetti.circle { border-radius: 50%; }
        .confetti.star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 9998; display: none; align-items: center; justify-content: center; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border-subtle); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #connection-status { position: fixed; bottom: 12px; right: 12px; font-size: 11px; padding: 6px 10px; background: var(--bg-primary); border-radius: 8px; z-index: 100; border: 1px solid var(--border-subtle); }
        .xp-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: 800; color: var(--accent-green); z-index: 10004; pointer-events: none; animation: xpFloat 1.5s ease forwards; }
        @keyframes xpFloat { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -100%) scale(1.5); } }
        @keyframes logoGlow { 0% { filter: drop-shadow(0 0 8px var(--accent-gold)) drop-shadow(0 0 15px rgba(251, 191, 36, 0.4)); } 100% { filter: drop-shadow(0 0 12px var(--accent-gold)) drop-shadow(0 0 20px rgba(251, 191, 36, 0.5)); } }
        .murim-logo { width: 100%; max-width: 280px; height: auto; margin-bottom: 24px; }
        #your-turn-btn { background: var(--primary-action); color: #000; font-size: 11px; font-weight: 900; padding: 8px 18px; border-radius: 25px; border: none; display: none; animation: pulse-glow 1.5s infinite; }
    </style>
</head>
<body>
<div id="toast"></div>
<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div id="connection-status">üü¢ Connected</div>
<div id="achievement-popup"></div>
<div id="streak-indicator"><img src="/icon/streak.svg" alt="Streak" style="width:20px;height:20px"><span id="streak-count">0</span><div style="font-size:9px;opacity:0.6">WIN STREAK</div></div>

<!-- Screen Edge Glow for Your Turn -->
<div id="turn-glow"></div>

<div class="modal-overlay" id="profile-modal">
    <div class="profile-card">
        <h3 style="color:var(--ui-blue);margin-top:0">CULTIVATION PROFILE</h3>
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:15px">
            <span id="prof-name" style="font-size:18px;font-weight:800;color:#fff"></span>
            <button onclick="editNamePrompt()" style="background:var(--glass-light);border:1px solid var(--border);color:#fff;padding:4px 10px;border-radius:8px;font-size:10px;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:4px"><img src="/icon/edit.svg" alt="" style="width:14px;height:14px"> EDIT</button>
        </div>
        <div id="prof-equipped-title" style="margin-bottom:15px"></div>
        <div id="prof-level" style="font-size:28px;font-weight:800">LEVEL 1</div>
        <div id="prof-rank-title" style="color:var(--primary-action);margin-bottom:15px">APPRENTICE</div>
        <div style="text-align:right;font-size:10px;color:#aaa" id="prof-progress-text">XP: 0/100</div>
        <div class="bar-container"><div id="prof-bar-fill" class="bar-fill"></div></div>
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-value" id="prof-xp">0</div><div class="stat-label">Total XP</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-wins">0</div><div class="stat-label">1st Place</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-pangkahs">0</div><div class="stat-label">Pangkahs</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-games">0</div><div class="stat-label">Games</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-streak">0</div><div class="stat-label">Best Streak</div></div>
            <div class="stat-box"><div class="stat-value" id="prof-winrate">0%</div><div class="stat-label">Win Rate</div></div>
        </div>
        <button class="btn btn-gold" onclick="openTitles()" style="margin-bottom:10px">VIEW TITLES</button>
        <button id="gm-logout-btn" class="btn" onclick="gmLogout()" style="margin-bottom:10px;background:linear-gradient(90deg,#ff6b6b,#ffd700);color:#000;display:none">‚öúÔ∏è EXIT GM MODE</button>
        <button class="btn btn-p" onclick="closeProfile()">RETURN</button>
    </div>
</div>

<div class="modal-overlay" id="titles-modal">
    <div class="titles-card">
        <h3 style="color:var(--purple);margin-top:0;display:flex;align-items:center;justify-content:center;gap:8px"><img src="/icon/halloffame.svg" alt="" style="width:24px;height:24px;filter:brightness(0) invert(1)"> ACHIEVEMENT TITLES</h3>
        <p style="font-size:11px;opacity:0.6;margin-bottom:15px">Unlock titles and equip one to display!</p>
        <div class="filter-tabs" id="title-filters"></div>
        <div class="title-grid" id="title-grid"></div>
        <div id="title-pagination" style="display:flex;justify-content:center;align-items:center;gap:12px;margin-top:15px">
            <button class="btn" onclick="titleNav(-1)" style="padding:8px 16px;background:rgba(255,255,255,0.1);color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center"><img src="/icon/chevron-left.svg" alt="Prev" style="width:16px;height:16px;filter:brightness(0) invert(1)"></button>
            <span id="title-page-indicator" style="font-size:12px;color:rgba(255,255,255,0.7);min-width:50px;text-align:center">1 / 1</span>
            <button class="btn" onclick="titleNav(1)" style="padding:8px 16px;background:rgba(255,255,255,0.1);color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center"><img src="/icon/chevron-right.svg" alt="Next" style="width:16px;height:16px;filter:brightness(0) invert(1)"></button>
        </div>
        <button class="btn btn-s" onclick="closeTitles()" style="margin-top:15px">BACK</button>
    </div>
</div>

<div id="swap-modal">
    <div id="swap-txt" style="font-size:14px;margin-bottom:20px;font-weight:600"></div>
    <div id="swap-timer" style="font-size:12px;margin-bottom:15px;color:#f59e0b">15s</div>
    <div style="display:flex;gap:12px">
        <button class="btn btn-p" onclick="answerSwap(true)">ACCEPT</button>
        <button class="btn" onclick="answerSwap(false)" style="background:rgba(255,255,255,0.1);color:white">DECLINE</button>
    </div>
</div>

<div class="modal-overlay" id="gameover-modal">
    <div class="gameover-card">
        <h2 style="color:var(--danger);margin-top:0">‚öîÔ∏è DUEL COMPLETE</h2>
        <div id="game-number" style="font-size:11px;opacity:0.6;margin-bottom:15px"></div>
        <div class="finish-list" id="finish-list"></div>
        <div class="bonus-list" id="bonus-list"></div>
        <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border-subtle);display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-primary" id="rematch-btn" onclick="requestRematch()">üîÑ REMATCH (0/0)</button>
            <button class="btn btn-gold" onclick="backToLobby()">üè† BACK TO LOBBY</button>
        </div>
    </div>
</div>

<div id="lobby">
    <!-- Header - Full Width Top -->
    <div class="lobby-header">
        <div class="lobby-header-left">
            <img src="/PM-logo.png" alt="Pangkah Murim" class="header-logo">
        </div>
        <div class="lobby-header-right">
            <button class="header-btn profile-btn" onclick="openProfile()" title="Profile"><img src="/icon/profile.svg" alt="Profile" style="width:18px;height:18px;filter:brightness(0) invert(1)"></button>
            <button class="header-btn leaderboard-btn" onclick="openLeaderboard()" title="Leaderboard"><img src="/icon/leaderboard.svg" alt="Leaderboard" style="width:18px;height:18px"></button>
            <button class="header-btn gm-admin-header-btn" id="gm-admin-header-btn" onclick="openGMAdmin()" title="GM Admin Panel" style="display:none;background:linear-gradient(135deg,#fbbf24,#f43f5e);border:none"><img src="/icon/profile.svg" alt="GM" style="width:18px;height:18px;filter:brightness(0) invert(1)"></button>
            <button class="header-btn hamburger-btn" id="hamburger-btn" onclick="toggleHeaderMenu()" aria-label="Menu" title="Menu"><img src="/icon/hambuger.svg" alt="Menu" style="width:18px;height:18px"></button>
        </div>
    </div>

    <!-- Mobile Menu (hamburger) -->
    <div class="header-menu" id="header-menu" aria-hidden="true">
        <div class="header-menu-card">
            <div class="header-menu-namecard">
                <img id="menu-badge" src="/badge/apprentice-badge.png" alt="badge" class="header-badge">
                <div class="header-player-info">
                    <span id="menu-name" class="header-name"></span>
                    <span id="menu-title" class="header-title"></span>
                </div>
            </div>
        </div>
        <button class="header-menu-item" onclick="openProfile(); closeHeaderMenu();"><img src="/icon/profile.svg" alt="" style="width:16px;height:16px;filter:brightness(0) invert(1);vertical-align:middle;margin-right:8px">Profile</button>
        <button class="header-menu-item" onclick="openLeaderboard(); closeHeaderMenu();"><img src="/icon/leaderboard.svg" alt="" style="width:16px;height:16px;vertical-align:middle;margin-right:8px">Leaderboard</button>
        <button class="header-menu-item gm-only" id="gm-admin-btn" onclick="openGMAdmin(); closeHeaderMenu();" style="display:none;color:var(--accent-red)"><img src="/icon/profile.svg" alt="" style="width:16px;height:16px;filter:invert(27%) sepia(94%) saturate(5826%) hue-rotate(354deg) brightness(91%) contrast(130%);vertical-align:middle;margin-right:8px">GM Admin Panel</button>
    </div>
    
    <!-- Body - Centered Panel -->
    <div class="lobby-body">
        <div class="panel">
            <div class="room-list" id="room-box"></div>
            <input id="rid" placeholder="Enter Sect ID" maxlength="20">
            <select id="maxp">
                <option value="4">4 Players</option>
                <option value="5">5 Players</option>
                <option value="6">6 Players</option>
                <option value="7">7 Players</option>
                <option value="8">8 Players</option>
                <option value="10">10 Players</option>
            </select>
            <select id="botcount">
                <option value="0">No Bots</option>
                <option value="1">1 Bot</option>
                <option value="2">2 Bots</option>
                <option value="3">3 Bots</option>
            </select>
            <button class="btn btn-p" onclick="enter('create')">CREATE SECT</button>
            <button class="btn btn-s" onclick="enter('join')" style="margin-top:8px">JOIN SECT</button>
            <div onclick="openHowToPlay()" style="margin-top:20px;color:var(--ui-blue);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;opacity:0.8;transition:opacity 0.2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                <img src="/icon/howtoplay.svg" alt="" style="width:18px;height:18px;filter:brightness(0) invert(1)"> How to Play Pangkah
            </div>
        </div>
    </div>
</div>

<!-- Leaderboard Modal -->
<div class="modal-overlay" id="leaderboard-modal" style="display:none">
    <div class="leaderboard-card">
        <h3 style="color:var(--gold);margin-top:0;display:flex;align-items:center;justify-content:center;gap:8px"><img src="/icon/halloffame.svg" alt="" style="width:24px;height:24px;filter:brightness(0) invert(1)"> HALL OF FAME</h3>
        
        <!-- Hall of Fame Records -->
        <div class="hof-container" id="hof-container">
            <div class="hof-grid" id="hof-grid"></div>
            <div id="hof-pagination" style="display:flex;justify-content:center;align-items:center;gap:12px;margin:15px 0">
                <button class="btn" onclick="hofNav(-1)" style="width:44px;padding:8px 0;background:rgba(255,255,255,0.1);color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center"><img src="/icon/chevron-left.svg" alt="Prev" style="width:16px;height:16px;filter:brightness(0) invert(1)"></button>
                <span id="hof-page-indicator" style="font-size:12px;color:rgba(255,255,255,0.7);white-space:nowrap">1 / 1</span>
                <button class="btn" onclick="hofNav(1)" style="width:44px;padding:8px 0;background:rgba(255,255,255,0.1);color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center"><img src="/icon/chevron-right.svg" alt="Next" style="width:16px;height:16px;filter:brightness(0) invert(1)"></button>
            </div>
            <div style="display:flex;gap:10px">
                <button class="btn btn-s" onclick="toggleFullTable()" style="flex:1">SHOW TABLE</button>
                <button class="btn btn-s" onclick="closeLeaderboard()" style="flex:1">CLOSE</button>
            </div>
        </div>
        
        <!-- Full Leaderboard Table (hidden by default) -->
        <div id="full-table-section" style="display:none">
            <div class="leaderboard-filters">
                <select id="lb-sort" onchange="loadLeaderboard()">
                    <option value="winrate">Sort by Win Rate</option>
                    <option value="xp">Sort by XP</option>
                    <option value="wins">Sort by Wins</option>
                    <option value="losses">Sort by Losses</option>
                    <option value="streak">Sort by Win Streak</option>
                    <option value="pangkahs">Sort by Pangkah Dealt</option>
                    <option value="pangkahsReceived">Sort by Got Pangkah</option>
                </select>
            </div>
            <div class="leaderboard-table-wrapper">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Player (LVL)</th>
                            <th>Games</th>
                            <th>Win</th>
                            <th>W%</th>
                            <th>Lose</th>
                            <th>L%</th>
                            <th>2nd</th>
                            <th>3rd</th>
                            <th>4-10th</th>
                            <th>PK</th>
                            <th>GPK</th>
                        </tr>
                    </thead>
                    <tbody id="lb-body"></tbody>
                </table>
            </div>
            <div id="lb-pagination" style="display:flex;justify-content:center;align-items:center;gap:12px;margin-top:15px">
                <button class="btn" onclick="lbNav(-1)" style="width:44px;padding:8px 0;background:rgba(255,255,255,0.1);color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center"><img src="/icon/chevron-left.svg" alt="Prev" style="width:16px;height:16px;filter:brightness(0) invert(1)"></button>
                <span id="lb-page-indicator" style="font-size:12px;color:rgba(255,255,255,0.7);white-space:nowrap;flex:0 0 auto;text-align:center">1 / 1</span>
                <button class="btn" onclick="lbNav(1)" style="width:44px;padding:8px 0;background:rgba(255,255,255,0.1);color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center"><img src="/icon/chevron-right.svg" alt="Next" style="width:16px;height:16px;filter:brightness(0) invert(1)"></button>
            </div>
            <div style="display:flex;gap:10px;margin-top:15px">
                <button class="btn btn-s" onclick="toggleFullTable()" style="flex:1">BACK TO HOF</button>
                <button class="btn btn-s" onclick="closeLeaderboard()" style="flex:1">CLOSE</button>
            </div>
        </div>
    </div>
</div>

<!-- GM Admin Panel Modal -->
<div class="modal-overlay" id="gm-admin-modal" style="display:none">
    <div class="leaderboard-card" style="max-width:500px">
        <h3 style="color:var(--accent-red);margin-top:0;display:flex;align-items:center;justify-content:center;gap:8px">‚öôÔ∏è GM ADMIN PANEL</h3>
        
        <!-- Active Rooms Section -->
        <div style="margin-bottom:15px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <label style="font-size:11px;color:var(--text-secondary)">ACTIVE ROOMS</label>
                <button onclick="gmRefreshRooms()" style="background:none;border:none;color:var(--accent-blue);cursor:pointer;font-size:11px">üîÑ Refresh</button>
            </div>
            <div id="gm-rooms-list" style="background:rgba(0,0,0,0.3);border-radius:8px;max-height:120px;overflow-y:auto">
                <div style="padding:15px;text-align:center;color:var(--text-tertiary);font-size:11px">Loading...</div>
            </div>
        </div>
        
        <div style="margin-bottom:15px">
            <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:5px">SEARCH PLAYER</label>
            <div style="display:flex;gap:8px;align-items:stretch">
                <input id="gm-search-input" type="text" placeholder="Enter player name or userID" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--border-light);background:rgba(0,0,0,0.3);color:#fff;font-size:12px;margin-bottom:0">
                <button class="btn btn-p" onclick="gmSearchPlayer()" style="width:auto;padding:10px 15px;font-size:11px;height:auto;margin:0;display:flex;align-items:center">SEARCH</button>
            </div>
        </div>
        
        <div id="gm-player-result" style="display:none;background:rgba(0,0,0,0.3);border-radius:12px;padding:15px;margin-bottom:15px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <div>
                    <div id="gm-player-name" style="font-weight:800;font-size:16px;color:#fff"></div>
                    <div id="gm-player-id" style="font-size:10px;color:var(--text-tertiary)"></div>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                    <div id="gm-player-status" style="padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700"></div>
                </div>
            </div>
            
            <!-- Beta Tester Toggle -->
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(52,211,153,0.1);border:1px solid var(--accent-green);border-radius:8px;margin-bottom:15px">
                <div>
                    <div style="font-size:12px;font-weight:600;color:var(--accent-green)">üß™ Beta Tester</div>
                    <div style="font-size:10px;color:var(--text-tertiary)">Grant beta tester status</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="gm-beta-toggle" onchange="gmToggleBetaTester()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px">
                <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px">
                    <div style="font-size:10px;color:var(--text-tertiary)">XP</div>
                    <input id="gm-stat-xp" type="number" class="gm-stat-input" value="0">
                </div>
                <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px">
                    <div style="font-size:10px;color:var(--text-tertiary)">WINS</div>
                    <input id="gm-stat-wins" type="number" class="gm-stat-input" value="0">
                </div>
                <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px">
                    <div style="font-size:10px;color:var(--text-tertiary)">LOSSES</div>
                    <input id="gm-stat-losses" type="number" class="gm-stat-input" value="0">
                </div>
                <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px">
                    <div style="font-size:10px;color:var(--text-tertiary)">GAMES</div>
                    <input id="gm-stat-games" type="number" class="gm-stat-input" value="0">
                </div>
                <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px">
                    <div style="font-size:10px;color:var(--text-tertiary)">PANGKAHS</div>
                    <input id="gm-stat-pangkahs" type="number" class="gm-stat-input" value="0">
                </div>
                <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px">
                    <div style="font-size:10px;color:var(--text-tertiary)">BEST STREAK</div>
                    <input id="gm-stat-bestStreak" type="number" class="gm-stat-input" value="0">
                </div>
            </div>
            
            <div style="display:flex;gap:10px;margin-bottom:10px">
                <button class="btn btn-p" onclick="gmSavePlayer()" style="flex:1;font-size:11px">üíæ SAVE CHANGES</button>
                <button class="btn" onclick="gmResetPlayer()" style="flex:1;font-size:11px;background:var(--accent-red);color:#fff">üîÑ RESET STATS</button>
            </div>
            <button class="btn" onclick="gmDeletePlayer()" style="width:100%;font-size:11px;background:#8B0000;color:#fff;border:2px solid #FF0000">‚ò†Ô∏è DELETE PLAYER (PERMANENT)</button>
        </div>
        
        <div id="gm-no-result" style="display:none;text-align:center;padding:20px;color:var(--text-tertiary)">
            No player found. Try a different search.
        </div>
        
        <button class="btn btn-s" onclick="closeGMAdmin()" style="width:100%;margin-top:10px">CLOSE</button>
    </div>
</div>

<!-- How to Play Modal - Paginated -->
<div class="modal-overlay" id="howtoplay-modal" style="display:none">
    <div class="howtoplay-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <h3 style="color:var(--gold);margin:0;font-size:1.2rem;display:flex;align-items:center;gap:8px"><img src="/icon/howtoplay.svg" alt="" style="width:22px;height:22px;filter:brightness(0) invert(1)"> HOW TO PLAY</h3>
            <span id="guide-page-indicator" style="font-size:11px;color:rgba(255,255,255,0.6)">1 / 5</span>
        </div>
        
        <div id="guide-content" style="min-height:280px"></div>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:15px;gap:10px">
            <button class="btn" id="guide-prev-btn" onclick="guideNav(-1)" style="flex:1;background:rgba(255,255,255,0.1);color:#fff;padding:10px;display:flex;align-items:center;justify-content:center;gap:4px"><img src="/icon/chevron-left.svg" alt="" style="width:14px;height:14px;filter:brightness(0) invert(1)"> PREV</button>
            <button class="btn btn-gold" onclick="closeHowToPlay()" style="flex:1;padding:10px;font-size:11px">SKIP</button>
            <button class="btn btn-p" id="guide-next-btn" onclick="guideNav(1)" style="flex:1;padding:10px;display:flex;align-items:center;justify-content:center;gap:4px">NEXT <img src="/icon/chevron-right.svg" alt="" style="width:14px;height:14px;filter:brightness(0) invert(1)"></button>
        </div>
    </div>
</div>
</div>

<div id="round-popup"><div id="pop-title"></div><div id="pop-desc"></div></div>

<div class="header">
    <div id="room-tag" style="color:var(--ui-blue);font-weight:800;font-size:11px">LOBBY</div>
    <div id="fate-display" style="display:none;align-items:center;background:rgba(0,0,0,0.3);padding:4px 12px;border-radius:10px;font-size:12px"></div>
    <div style="display:flex;align-items:center;gap:12px">
        <button id="close-room-btn" onclick="closeRoom()" style="display:none;background:var(--danger);color:white;border:none;padding:6px 12px;border-radius:8px;font-size:10px;font-weight:800;cursor:pointer">DISBAND</button>
        <div id="suit-indicator" style="display:none;align-items:center;background:rgba(255,255,255,0.05);padding:4px 10px;border-radius:10px"><span id="suit-symbol" style="font-size:1.2rem"></span></div>
    </div>
</div>

<div id="game-view">
    <div class="safe-wrap" id="table-wrap">
        <div id="p-layer"></div>
        <div id="t-layer"></div>
        <button id="start-btn" class="btn" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:auto;padding:15px 30px;font-size:14px" onclick="start()">BEGIN DUEL (0/0)</button>
    </div>
</div>

<div id="hand-area">
    <div class="hand-header">
        <div id="turn-indicator-inline">‚ö° YOUR TURN <span id="turn-timer"></span></div>
        <button class="btn" style="width:auto;padding:6px 18px;font-size:11px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid var(--border-light);border-radius:12px;display:flex;align-items:center;gap:4px" onclick="sortHand()">SORT <img src="/icon/sort.svg" alt="" style="width:14px;height:14px;filter:brightness(0) invert(1)"></button>
        <div id="emote-bar">
            <button class="emote-btn" onclick="sendEmote('üòÇ')">üòÇ</button>
            <button class="emote-btn" onclick="sendEmote('üëç')">üëç</button>
            <button class="emote-btn" onclick="sendEmote('üò°')">üò°</button>
            <button class="emote-btn" onclick="sendEmote('üî•')">üî•</button>
            <button class="emote-btn" onclick="sendEmote('üíÄ')">üíÄ</button>
            <button class="emote-btn" onclick="sendEmote('üëè')">üëè</button>
        </div>
    </div>
    <div class="hand-flex" id="my-cards"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// Audio setup with proper paths and error handling
const sfx = {
    place: new Audio('/place.mp3'),
    sweep: new Audio('/sweep.mp3'),
    strike: new Audio('/strike.mp3'),
    absorb: new Audio('/absorb.mp3')
};
Object.values(sfx).forEach(a => { a.volume = 0.3; a.load(); });

// Enable audio after first user interaction (browser policy)
let audioEnabled = false;
function enableAudio() {
    if (audioEnabled) return;
    audioEnabled = true;
    Object.values(sfx).forEach(a => {
        a.play().then(() => a.pause()).catch(() => {});
        a.currentTime = 0;
    });
    document.removeEventListener('click', enableAudio);
    document.removeEventListener('touchstart', enableAudio);
}
document.addEventListener('click', enableAudio);
document.addEventListener('touchstart', enableAudio);

function playSound(name) {
    if (sfx[name]) {
        sfx[name].currentTime = 0;
        sfx[name].play().catch(() => {});
    }
}

const TITLES=[
// LEGENDARY (14 total)
{id:'ancient_ancestor',name:'Ancient Ancestor',desc:'Reach Level 50',rarity:'legendary',icon:'üêâ',req:{t:'level',v:50}},
{id:'pangkah_god',name:'Pangkah God',desc:'500 Pangkahs dealt',rarity:'legendary',icon:'‚ö°',req:{t:'pangkahs',v:500}},
{id:'unbreakable',name:'The Unbreakable',desc:'10 win streak',rarity:'legendary',icon:'üíé',req:{t:'streak',v:10}},
{id:'thousand_victories',name:'Thousand Victories',desc:'Win 1000 games',rarity:'legendary',icon:'üëë',req:{t:'wins',v:1000}},
{id:'sect_master',name:'Sect Master',desc:'Play 2000 games',rarity:'legendary',icon:'üèØ',req:{t:'games',v:2000}},
{id:'immortal',name:'Immortal',desc:'100,000 XP earned',rarity:'legendary',icon:'‚ú®',req:{t:'xp',v:100000}},
{id:'card_billionaire',name:'Card Billionaire',desc:'Hold 30+ cards in one game',rarity:'legendary',icon:'üí∞',req:{t:'maxCardsHeld',v:30}},
{id:'comeback_king',name:'Comeback King',desc:'Win after holding 25+ cards (5x)',rarity:'legendary',icon:'üëä',req:{t:'comebacks',v:5}},
{id:'perfect_game',name:'Flawless',desc:'Win without receiving pangkah (10x)',rarity:'legendary',icon:'üåü',req:{t:'perfectWins',v:10}},
{id:'social_emperor',name:'Social Emperor',desc:'Play with 200 unique players',rarity:'legendary',icon:'ü§ù',req:{t:'uniquePlayers',v:200}},
{id:'no_life',name:'No Life',desc:'Play 5000 games',rarity:'legendary',icon:'üíÄ',req:{t:'games',v:5000}},
{id:'ultimate_loser',name:'Professional Clown',desc:'Lose 500 games',rarity:'legendary',icon:'üé™',req:{t:'losses',v:500}},
{id:'clean_legend',name:'Spotless Legend',desc:'500 clean round wins',rarity:'legendary',icon:'üßº',req:{t:'cleanWins',v:500}},
{id:'hand_emperor',name:'Hand Emperor',desc:'Absorb 200 hands',rarity:'legendary',icon:'ü¶ë',req:{t:'handsAbsorbed',v:200}},
// EPIC (16 total)
{id:'grandmaster',name:'Grandmaster',desc:'Reach Level 30',rarity:'epic',icon:'üé≠',req:{t:'level',v:30}},
{id:'pangkah_master',name:'Pangkah Master',desc:'200 Pangkahs dealt',rarity:'epic',icon:'üî•',req:{t:'pangkahs',v:200}},
{id:'untouchable',name:'Untouchable',desc:'7 win streak',rarity:'epic',icon:'üõ°Ô∏è',req:{t:'streak',v:7}},
{id:'champion',name:'Champion',desc:'Win 500 games',rarity:'epic',icon:'üèÜ',req:{t:'wins',v:500}},
{id:'veteran',name:'Battle Veteran',desc:'Play 1000 games',rarity:'epic',icon:'‚öîÔ∏è',req:{t:'games',v:1000}},
{id:'enlightened',name:'Enlightened One',desc:'50,000 XP earned',rarity:'epic',icon:'üå∏',req:{t:'xp',v:50000}},
{id:'absorber',name:'Soul Absorber',desc:'Absorb 100 hands',rarity:'epic',icon:'üëª',req:{t:'handsAbsorbed',v:100}},
{id:'night_owl',name:'Night Owl',desc:'100 games at night',rarity:'epic',icon:'ü¶â',req:{t:'nightGames',v:100}},
{id:'card_hoarder',name:'Card Hoarder',desc:'Hold 25+ cards in one game',rarity:'epic',icon:'üêøÔ∏è',req:{t:'maxCardsHeld',v:25}},
{id:'serial_loser',name:'Professional Loser',desc:'Lose 100 games',rarity:'epic',icon:'ü§°',req:{t:'losses',v:100}},
{id:'survivor',name:'Sole Survivor',desc:'50 comeback wins',rarity:'epic',icon:'ü¶æ',req:{t:'comebacks',v:50}},
{id:'sleepwalker',name:'Sleepwalker',desc:'100 auto-played turns',rarity:'epic',icon:'üßü',req:{t:'autoPlays',v:100}},
{id:'punching_bag',name:'Punching Bag',desc:'Receive 200 pangkahs',rarity:'epic',icon:'ü•ä',req:{t:'pangkahsReceived',v:200}},
{id:'santa_claus',name:'Santa Claus',desc:'Give away 50 hands',rarity:'epic',icon:'üéÖ',req:{t:'handsGiven',v:50}},
{id:'clean_master',name:'Mr. Clean',desc:'200 clean round wins',rarity:'epic',icon:'üßπ',req:{t:'cleanWins',v:200}},
{id:'bronze_collector',name:'Bronze Collector',desc:'3rd place 50 times',rarity:'epic',icon:'ü•â',req:{t:'thirdPlace',v:50}},
// RARE (18 total)
{id:'master',name:'Master',desc:'Reach Level 15',rarity:'rare',icon:'üéØ',req:{t:'level',v:15}},
{id:'pangkah_adept',name:'Pangkah Adept',desc:'50 Pangkahs dealt',rarity:'rare',icon:'üí•',req:{t:'pangkahs',v:50}},
{id:'hot_streak',name:'Hot Streak',desc:'5 win streak',rarity:'rare',icon:'üåä',req:{t:'streak',v:5}},
{id:'conqueror',name:'Conqueror',desc:'Win 100 games',rarity:'rare',icon:'üó°Ô∏è',req:{t:'wins',v:100}},
{id:'dedicated',name:'Dedicated',desc:'Play 500 games',rarity:'rare',icon:'üìø',req:{t:'games',v:500}},
{id:'cultivator',name:'Cultivator',desc:'10,000 XP earned',rarity:'rare',icon:'üå±',req:{t:'xp',v:10000}},
{id:'hand_collector',name:'Hand Collector',desc:'Absorb 30 hands',rarity:'rare',icon:'ü§≤',req:{t:'handsAbsorbed',v:30}},
{id:'social',name:'Social Butterfly',desc:'50 unique players',rarity:'rare',icon:'ü¶ã',req:{t:'uniquePlayers',v:50}},
{id:'consistent',name:'Consistent',desc:'Top 2 finish 50 times',rarity:'rare',icon:'üìà',req:{t:'topTwo',v:50}},
{id:'second_best',name:'Always Second',desc:'2nd place 25 times',rarity:'rare',icon:'ü•à',req:{t:'secondPlace',v:25}},
{id:'card_magnet',name:'Card Magnet',desc:'Hold 20+ cards in one game',rarity:'rare',icon:'üß≤',req:{t:'maxCardsHeld',v:20}},
{id:'generous_soul',name:'Generous Soul',desc:'Give away 20 hands',rarity:'rare',icon:'üéÅ',req:{t:'handsGiven',v:20}},
{id:'afk_master',name:'AFK Master',desc:'50 auto-played turns',rarity:'rare',icon:'üò¥',req:{t:'autoPlays',v:50}},
{id:'clean_player',name:'Clean Freak',desc:'100 clean round wins',rarity:'rare',icon:'‚ú®',req:{t:'cleanWins',v:100}},
{id:'pangkah_victim',name:'Pangkah Victim',desc:'Receive 100 pangkahs',rarity:'rare',icon:'üò≠',req:{t:'pangkahsReceived',v:100}},
{id:'silent_killer',name:'Silent Killer',desc:'Win 50 games with 0 pangkahs dealt',rarity:'rare',icon:'ü•∑',req:{t:'silentWins',v:50}},
{id:'marathon',name:'Marathon Runner',desc:'Play 10 games in one day',rarity:'rare',icon:'üèÉ',req:{t:'dailyGames',v:10}},
{id:'elder',name:'Elder',desc:'Reach Level 20',rarity:'rare',icon:'üë¥',req:{t:'level',v:20}},
// COMMON (22 total)
{id:'warrior',name:'Warrior',desc:'Reach Level 5',rarity:'common',icon:'‚öîÔ∏è',req:{t:'level',v:5}},
{id:'first_pangkah',name:'First Strike',desc:'Deal your first Pangkah',rarity:'common',icon:'üéØ',req:{t:'pangkahs',v:1}},
{id:'first_blood',name:'First Blood',desc:'Win your first game',rarity:'common',icon:'ü©∏',req:{t:'wins',v:1}},
{id:'newcomer',name:'Newcomer',desc:'Play 10 games',rarity:'common',icon:'üåü',req:{t:'games',v:10}},
{id:'regular',name:'Regular',desc:'Play 50 games',rarity:'common',icon:'üéÆ',req:{t:'games',v:50}},
{id:'learner',name:'Quick Learner',desc:'Earn 1,000 XP',rarity:'common',icon:'üìö',req:{t:'xp',v:1000}},
{id:'pangkah_novice',name:'Pangkah Novice',desc:'10 Pangkahs dealt',rarity:'common',icon:'üî∞',req:{t:'pangkahs',v:10}},
{id:'victor',name:'Victor',desc:'Win 10 games',rarity:'common',icon:'üèÖ',req:{t:'wins',v:10}},
{id:'determined',name:'Determined',desc:'Win 25 games',rarity:'common',icon:'üí™',req:{t:'wins',v:25}},
{id:'hand_taker',name:'Hand Taker',desc:'Absorb 5 hands',rarity:'common',icon:'‚úã',req:{t:'handsAbsorbed',v:5}},
{id:'streak_starter',name:'Streak Starter',desc:'3 win streak',rarity:'common',icon:'üî•',req:{t:'streak',v:3}},
{id:'persistent',name:'Persistent',desc:'Play 100 games',rarity:'common',icon:'üé≤',req:{t:'games',v:100}},
{id:'collector',name:'Card Collector',desc:'Play 1000 cards',rarity:'common',icon:'üÉè',req:{t:'cardsPlayed',v:1000}},
{id:'runner_up',name:'Runner Up',desc:'2nd place 5 times',rarity:'common',icon:'ü•à',req:{t:'secondPlace',v:5}},
{id:'third_wheel',name:'Third Wheel',desc:'3rd place 5 times',rarity:'common',icon:'ü•â',req:{t:'thirdPlace',v:5}},
{id:'first_loser',name:'First Loser',desc:'Lose your first game',rarity:'common',icon:'üíî',req:{t:'losses',v:1}},
{id:'unlucky',name:'Unlucky',desc:'Lose 10 games',rarity:'common',icon:'üçÄ',req:{t:'losses',v:10}},
{id:'sleepy',name:'Sleepy',desc:'Get auto-played 10 times',rarity:'common',icon:'üí§',req:{t:'autoPlays',v:10}},
{id:'friendly',name:'Friendly',desc:'Play with 10 unique players',rarity:'common',icon:'üëã',req:{t:'uniquePlayers',v:10}},
{id:'give_hand',name:'Helping Hand',desc:'Give away your hand once',rarity:'common',icon:'ü§ù',req:{t:'handsGiven',v:1}},
{id:'heavy_hand',name:'Heavy Handed',desc:'Hold 15+ cards in one game',rarity:'common',icon:'üéí',req:{t:'maxCardsHeld',v:15}},
{id:'clean_start',name:'Clean Start',desc:'Win 10 clean rounds',rarity:'common',icon:'üßΩ',req:{t:'cleanWins',v:10}}
];
const socket=io(),icons={Spades:'‚ô†',Hearts:'‚ô•',Diamonds:'‚ô¶',Clubs:'‚ô£'},XP_PER_LEVEL=100;

// User ID - stored locally but all stats come from server
let userID=localStorage.getItem('pUserID')||'uid_'+Math.random().toString(36).substr(2,9);localStorage.setItem('pUserID',userID);
let myName=localStorage.getItem('pName')||'Disciple'+Math.floor(Math.random()*999);

// Stats object - populated from MongoDB server
let stats={xp:0,pangkahs:0,pangkahsReceived:0,wins:0,losses:0,games:0,currentStreak:0,bestStreak:0,handsAbsorbed:0,handsGiven:0,cleanWins:0,maxCardsHeld:0,autoPlays:0,cardsPlayed:0,secondPlace:0,thirdPlace:0,fourthToTenth:0,topTwo:0,nightGames:0,unlockedTitles:[],equippedTitle:null,isBetaTester:false};

// GM System
let isGameMaster = localStorage.getItem('pGM') === 'true';
const GM_TITLES = [
    {id:'celestial_marshal',name:'Celestial Marshal',desc:'Game Master Exclusive',rarity:'special',icon:'‚öúÔ∏è',req:{t:'gm',v:1}},
    {id:'shadow_magistrate',name:'Shadow Magistrate',desc:'Game Master Exclusive',rarity:'special',icon:'üê∫',req:{t:'gm',v:1}}
];

// Beta Tester Titles
const BETA_TITLES = [
    {id:'dragon_vanguard',name:'Dragon Vanguard',desc:'Beta Tester Exclusive',rarity:'special',icon:'üêâ',req:{t:'beta',v:1}},
    {id:'founders_circle',name:"Founders' Circle",desc:'Beta Tester Exclusive',rarity:'special',icon:'üëë',req:{t:'beta',v:1}},
    {id:'supreme_leader',name:'Supreme Leader',desc:'Beta Tester Exclusive',rarity:'special',icon:'üó°Ô∏è',req:{t:'beta',v:1}}
];

// Hall of Fame Frame System
let hofFrameHolders = {};
const HOF_FRAMES = [
    { id: 'winrate', record: 'winrate', class: 'frame-winrate', name: 'Win Rate Champion' },
    { id: 'streak', record: 'streak', class: 'frame-streak', name: 'Streak Master' },
    { id: 'pangkah', record: 'pangkah', class: 'frame-pangkah', name: 'Pangkah King' },
    { id: 'loserate', record: 'loserate', class: 'frame-loserate', name: 'Lose Rate Champion' },
    { id: 'magnet', record: 'magnet', class: 'frame-magnet', name: 'Pangkah Magnet' }
];

async function fetchHofFrameHolders() {
    try {
        const res = await fetch('/api/hof-frames');
        if (res.ok) {
            const data = await res.json();
            hofFrameHolders = data.holders || {};
        }
    } catch (e) { console.log('Failed to fetch HOF frames'); }
}

function getPlayerFrame(playerUserID, playerIsGM) {
    if (playerIsGM) return 'frame-gm';
    for (const frame of HOF_FRAMES) {
        if (hofFrameHolders[frame.id] === playerUserID) return frame.class;
    }
    return '';
}

let myRoom='',myCurrentHand=[],pendingSwapRequest=null,swapTimeoutId=null,isProcessingTurn=false,isHost=false,isFirstMove=true,currentLeadSuit=null,currentFilter='all',currentMaxPlayers=4;

// Load player data from MongoDB on page load
async function loadPlayerData(){
    try{
        console.log('üîÑ Loading player data from MongoDB for userID:', userID);
        const res=await fetch(`/api/player/${userID}`);
        console.log('üì° Response status:', res.status);
        if(res.ok){
            const data=await res.json();
            console.log('üì• Full player data received:', JSON.stringify(data));
            
            // Update stats from server
            stats={
                xp:data.xp||0,
                wins:data.wins||0,
                losses:data.losses||0,
                games:data.games||0,
                pangkahs:data.pangkahs||0,
                pangkahsReceived:data.pangkahsReceived||0,
                bestStreak:data.bestStreak||0,
                currentStreak:data.currentStreak||0,
                handsAbsorbed:data.handsAbsorbed||0,
                handsGiven:data.handsGiven||0,
                cleanWins:data.cleanWins||0,
                maxCardsHeld:data.maxCardsHeld||0,
                autoPlays:data.autoPlays||0,
                cardsPlayed:data.cardsPlayed||0,
                secondPlace:data.secondPlace||0,
                thirdPlace:data.thirdPlace||0,
                fourthToTenth:data.fourthToTenth||0,
                topTwo:data.topTwo||0,
                nightGames:data.nightGames||0,
                unlockedTitles:data.unlockedTitles||[],
                equippedTitle:data.equippedTitle||null,
                isBetaTester:data.isBetaTester||false
            };
            
            console.log('üìä Stats loaded - XP:', stats.xp, 'Wins:', stats.wins, 'Games:', stats.games);
            console.log('üéñÔ∏è Unlocked titles:', stats.unlockedTitles);
            console.log('üèÜ Equipped title:', stats.equippedTitle);
            console.log('üß™ Beta tester:', stats.isBetaTester);
            
            // Sync display name
            if(data.displayName && data.displayName !== myName){
                myName = data.displayName;
                localStorage.setItem('pName', myName);
            }
            
            updateStatsUI();
            checkAllTitles();
        }else{
            console.log('‚ùå Server returned error status:', res.status);
        }
    }catch(e){
        console.log('‚ùå Failed to load player data:', e.message);
    }
}

// Listen for server-side stats updates after games
socket.on('statsUpdated', (data) => {
    console.log('üìä Stats updated from server:', data);
    
    // Update local stats
    stats.xp = data.xp;
    stats.wins = data.wins;
    stats.losses = data.losses;
    stats.games = data.games;
    stats.pangkahs = data.pangkahs;
    stats.bestStreak = data.bestStreak;
    stats.currentStreak = data.currentStreak;
    stats.unlockedTitles = data.unlockedTitles;
    
    // Show XP popup
    if(data.xpGain){
        const p=document.createElement('div');
        p.className='xp-popup';
        p.style.color=data.xpGain>0?'var(--primary-action)':'var(--danger)';
        p.innerText=`${data.xpGain>0?'+':''}${data.xpGain} XP`;
        document.body.appendChild(p);
        setTimeout(()=>p.remove(),1500);
    }
    
    // Show new title notifications
    if(data.newTitles && data.newTitles.length > 0){
        data.newTitles.forEach(titleId => {
            const t = TITLES.find(x => x.id === titleId);
            if(t) showAchievement(t);
        });
    }
    
    // Check for level up
    const oldLevel = Math.floor((stats.xp - data.xpGain) / XP_PER_LEVEL) + 1;
    const newLevel = getLevel();
    if(newLevel > oldLevel){
        showToast(`‚ö° LEVEL UP! Lv.${newLevel}`, true);
    }
    
    updateStatsUI();
});

// Call on page load
document.addEventListener('DOMContentLoaded',()=>{
    loadPlayerData();
    fetchHofFrameHolders();
    if(isGameMaster){
        document.getElementById('gm-admin-btn').style.display='block';
        document.getElementById('gm-admin-header-btn').style.display='flex';
    }
});

function getStatValue(t){switch(t){case'level':return getLevel();case'pangkahs':return stats.pangkahs||0;case'streak':return stats.bestStreak||0;case'wins':return stats.wins||0;case'games':return stats.games||0;case'xp':return stats.xp||0;case'handsAbsorbed':return stats.handsAbsorbed||0;case'nightGames':return stats.nightGames||0;case'uniquePlayers':return(stats.uniquePlayers||[]).length;case'topTwo':return stats.topTwo||0;case'secondPlace':return stats.secondPlace||0;case'thirdPlace':return stats.thirdPlace||0;case'cardsPlayed':return stats.cardsPlayed||0;case'losses':return stats.losses||0;case'maxCardsHeld':return stats.maxCardsHeld||0;case'comebacks':return stats.comebacks||0;case'perfectWins':return stats.perfectWins||0;case'fastWins':return stats.fastWins||0;case'handsGiven':return stats.handsGiven||0;case'autoPlays':return stats.autoPlays||0;case'cleanWins':return stats.cleanWins||0;case'pangkahsReceived':return stats.pangkahsReceived||0;default:return 0;}}
function checkAllTitles(){TITLES.forEach(t=>{if(!stats.unlockedTitles.includes(t.id)&&getStatValue(t.req.t)>=t.req.v){stats.unlockedTitles.push(t.id);showAchievement(t);}});saveStats();}
function showAchievement(t){const p=document.getElementById('achievement-popup');p.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><span style="font-size:24px">${t.icon}</span><div><div style="font-size:10px;color:var(--gold);font-weight:800">TITLE UNLOCKED!</div><div style="font-size:16px;font-weight:800">${t.name}</div></div></div><div style="font-size:11px;opacity:0.7">${t.desc}</div><div class="title-rarity ${t.rarity}" style="margin-top:10px">${t.rarity.toUpperCase()}</div>`;p.style.display='block';setTimeout(()=>p.style.display='none',4000);}
function equipTitle(id){
    console.log('equipTitle called with id:', id);
    console.log('stats.unlockedTitles:', stats.unlockedTitles);
    console.log('isGameMaster:', isGameMaster);
    console.log('stats.isBetaTester:', stats.isBetaTester);
    
    // Check if title is unlocked (regular titles) or special titles (GM/Beta)
    const allTitles=[...TITLES,...GM_TITLES,...BETA_TITLES];
    const title=allTitles.find(t=>t.id===id);
    if(!title) {
        console.log('Title not found in allTitles');
        return;
    }
    
    const isGMTitle=title.req.t==='gm';
    const isBetaTitle=title.req.t==='beta';
    
    // Regular titles: must be in unlockedTitles
    // GM titles: must be GM
    // Beta titles: must be beta tester
    let canEquip = false;
    if(isGMTitle){
        canEquip = isGameMaster;
    } else if(isBetaTitle){
        canEquip = stats.isBetaTester;
    } else {
        canEquip = stats.unlockedTitles.includes(id);
    }
    
    console.log('canEquip:', canEquip);
    
    if(canEquip){
        equipTitleOnServer(id).then(success => {
            console.log('equipTitleOnServer result:', success);
            if(success){
                renderTitleGrid();
                if(myRoom)socket.emit('updateTitle',{roomID:myRoom,userID,title:getEquippedTitleData()});
                showToast('Equipped!',true);
            } else {
                showToast('Failed to equip',false);
            }
        });
    } else {
        console.log('Cannot equip - not unlocked');
        showToast('Title not unlocked',false);
    }
}
function unequipTitle(){
    equipTitleOnServer(null).then(success => {
        if(success){
            renderTitleGrid();
            if(myRoom)socket.emit('updateTitle',{roomID:myRoom,userID,title:null});
        }
    });
}
function getEquippedTitleData(){if(!stats.equippedTitle)return null;const allTitles=[...TITLES,...(isGameMaster?GM_TITLES:[]),...(stats.isBetaTester?BETA_TITLES:[])];const t=allTitles.find(x=>x.id===stats.equippedTitle);return t?{id:t.id,name:t.name,rarity:t.rarity,icon:t.icon}:null;}

// Title Pagination
let titlePage=0;
const TITLES_PER_PAGE=6;
function renderTitleGrid(){
    const grid=document.getElementById('title-grid'),filters=document.getElementById('title-filters');
    
    // Show special filter only if player has access to special titles
    const hasSpecialTitles = isGameMaster || stats.isBetaTester;
    const filterOptions = hasSpecialTitles ? ['all','special','legendary','epic','rare','common'] : ['all','legendary','epic','rare','common'];
    
    filters.innerHTML=filterOptions.map(r=>`<div class="filter-tab ${currentFilter===r?'active':''}" onclick="currentFilter='${r}';titlePage=0;renderTitleGrid()">${r==='all'?'ALL':r.toUpperCase()}</div>`).join('');
    
    // Include GM titles if GM, Beta titles if beta tester
    const allTitles=[...TITLES,...(isGameMaster?GM_TITLES:[]),...(stats.isBetaTester?BETA_TITLES:[])];
    const filtered=currentFilter==='all'?allTitles:allTitles.filter(t=>t.rarity===currentFilter);
    const totalPages=Math.ceil(filtered.length/TITLES_PER_PAGE)||1;
    const start=titlePage*TITLES_PER_PAGE;
    const pageItems=filtered.slice(start,start+TITLES_PER_PAGE);
    grid.innerHTML=pageItems.map(t=>{
        const isGMTitle=t.req.t==='gm';
        const isBetaTitle=t.req.t==='beta';
        const isSpecialTitle=isGMTitle||isBetaTitle;
        // Auto-unlock: GM titles for GMs, Beta titles for Beta Testers
        const unlocked=stats.unlockedTitles.includes(t.id)||(isGMTitle&&isGameMaster)||(isBetaTitle&&stats.isBetaTester);
        const equipped=stats.equippedTitle===t.id,prog=isSpecialTitle?1:getStatValue(t.req.t),max=t.req.v,pct=Math.min(prog/max*100,100).toFixed(0);
        const labelText=t.rarity==='special'?'SPECIAL':t.rarity.toUpperCase();
        const specialClass=isSpecialTitle?'special-title':'';
        return`<div class="title-item ${unlocked?'':'locked'} ${equipped?'equipped':''} ${specialClass}" onclick="${unlocked?(equipped?'unequipTitle()':`equipTitle('${t.id}')`):''}">${equipped?'<span style="position:absolute;top:8px;right:8px">‚úì</span>':''}<span class="title-rarity ${t.rarity}">${labelText}</span><div class="title-name">${t.icon} ${t.name}</div><div class="title-desc">${t.desc}</div>${!unlocked&&!isSpecialTitle?`<div class="title-progress">${Math.min(prog,max)}/${max} (${pct}%)</div>`:''}</div>`;
    }).join('');
    document.getElementById('title-page-indicator').innerText=`${titlePage+1} / ${totalPages}`;
}
function titleNav(dir){
    const allTitles=[...TITLES,...(isGameMaster?GM_TITLES:[]),...(stats.isBetaTester?BETA_TITLES:[])];
    const filtered=currentFilter==='all'?allTitles:allTitles.filter(t=>t.rarity===currentFilter);
    const totalPages=Math.ceil(filtered.length/TITLES_PER_PAGE)||1;
    titlePage=Math.max(0,Math.min(totalPages-1,titlePage+dir));
    renderTitleGrid();
}
function openTitles(){titlePage=0;document.getElementById('profile-modal').style.display='none';document.getElementById('titles-modal').style.display='flex';renderTitleGrid();}
function closeTitles(){document.getElementById('titles-modal').style.display='none';document.getElementById('profile-modal').style.display='flex';}

// Guide Pagination
let guidePage=0;
const GUIDE_PAGES=[
    {title:'üéØ Goal & Basic Rules',content:`
        <div class="guide-section">
            <div class="guide-title">üéØ GOAL OF THE GAME</div>
            <p>Get rid of ALL your cards before anyone else!</p>
            <p style="margin-top:8px;color:var(--danger)">‚ö†Ô∏è The <b>LAST player</b> holding cards <b>LOSES</b> the game!</p>
        </div>
        <div class="guide-section">
            <div class="guide-title">üÉè BASIC RULES</div>
            <div class="guide-step"><span class="step-num">1</span> <div>Player with <b>King of Spades (K‚ô†)</b> starts first</div></div>
            <div class="guide-step"><span class="step-num">2</span> <div>You <b>MUST play the same suit</b> if you have it<br><span style="font-size:10px;opacity:0.7">Example: If someone plays ‚ô•, you must play ‚ô•</span></div></div>
            <div class="guide-step"><span class="step-num">3</span> <div><b>HIGHEST card</b> of lead suit wins the round<br><span style="font-size:10px;opacity:0.7">A(low) ‚Üí 2 ‚Üí 3... ‚Üí J ‚Üí Q ‚Üí K(high)</span></div></div>
            <div class="guide-step"><span class="step-num">4</span> <div>Winner leads the next round</div></div>
        </div>`},
    {title:'‚ö° Pangkah Mechanic',content:`
        <div class="guide-section" style="border:1px solid var(--danger);background:rgba(244,63,94,0.1)">
            <div class="guide-title" style="color:var(--danger)">‚ö° PANGKAH - THE KEY MECHANIC!</div>
            <p>If you <b>DON'T have the lead suit</b>, play ANY card.</p>
            <p style="margin-top:8px">This is called <b style="color:var(--danger)">"PANGKAH"</b> (to cut/block)</p>
            <div class="pangkah-box">
                <div><b>When PANGKAH occurs:</b></div>
                <div style="margin-top:6px">1Ô∏è‚É£ Round <b>STOPS IMMEDIATELY</b></div>
                <div>2Ô∏è‚É£ <b>HIGHEST lead suit</b> holder takes ALL cards</div>
                <div>3Ô∏è‚É£ That player now has MORE cards!</div>
            </div>
            <p style="margin-top:10px;font-size:11px;color:var(--primary-action)">üí° <b>Tip:</b> Use Pangkah to dump cards onto opponents!</p>
        </div>
        <div class="guide-section">
            <div class="guide-title">‚ú® CLEAN ROUND</div>
            <p>If ALL players follow suit, highest wins and cards are <b>discarded</b> (removed from game).</p>
        </div>`},
    {title:'üîÑ Example Round',content:`
        <div class="guide-section">
            <div class="guide-title">üîÑ EXAMPLE ROUND</div>
            <div style="background:rgba(0,0,0,0.3);border-radius:8px;padding:12px;font-size:12px">
                <div style="margin-bottom:8px"><b>Player A</b> plays: <span style="color:var(--danger)">7‚ô•</span> (leads Hearts)</div>
                <div style="margin-bottom:8px"><b>Player B</b> plays: <span style="color:var(--danger)">K‚ô•</span> (follows - highest!)</div>
                <div style="margin-bottom:8px"><b>Player C</b> plays: <span>5‚ô†</span> (no ‚ô• = <b style="color:var(--danger)">PANGKAH!</b>)</div>
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:13px">
                    ‚ö° Round stops! <b>Player B</b> takes all 3 cards
                </div>
            </div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(16,185,129,0.1));border:1px solid var(--primary-action);border-radius:12px;padding:12px;margin-top:10px">
            <div style="font-weight:800;color:var(--primary-action);margin-bottom:6px">üí° KEY INSIGHT</div>
            <div style="font-size:11px">Player C had no Hearts, so played a Spade to "Pangkah" the round. Player B had the highest Heart (K‚ô•), so B must take all cards!</div>
        </div>`},
    {title:'ü§ù Take Hand & Timer',content:`
        <div class="guide-section">
            <div class="guide-title">ü§ù TAKE HAND (TH Button)</div>
            <p>Click <span style="color:var(--primary-action);font-weight:800">TH</span> on a player to request their hand!</p>
            <div style="font-size:11px;margin-top:8px;opacity:0.9">
                <div>‚Ä¢ Only works on <b>your turn</b></div>
                <div>‚Ä¢ Only targets <b>next player</b> with cards</div>
                <div>‚Ä¢ They can <b>Accept</b> or <b>Decline</b> (15s)</div>
                <div>‚Ä¢ If accepted, you absorb ALL their cards!</div>
            </div>
            <p style="margin-top:8px;font-size:11px;color:var(--gold)">üí° Help a friend survive by taking their cards!</p>
        </div>
        <div class="guide-section">
            <div class="guide-title">‚è±Ô∏è TURN TIMER (15 Seconds)</div>
            <p>You have <b>15 seconds</b> to play a card.</p>
            <div style="font-size:11px;margin-top:6px;opacity:0.9">
                <div>‚Ä¢ Timer next to "YOUR TURN"</div>
                <div>‚Ä¢ <span style="color:var(--danger)">RED</span> in last 5 seconds</div>
                <div>‚Ä¢ Time out = <b>auto-play</b></div>
            </div>
        </div>`},
    {title:'üèÜ XP & Summary',content:`
        <div class="guide-section">
            <div class="guide-title">üèÜ WINNING & XP</div>
            <div style="font-size:12px">
                <div>ü•á <b>1st Place:</b> +15 XP + streak bonus</div>
                <div>ü•à <b>2nd Place:</b> +8 XP</div>
                <div>ü•â <b>3rd Place:</b> +5 XP</div>
                <div>üíÄ <b>Last Place:</b> -2 XP</div>
                <div style="margin-top:8px">‚ö° <b>Bonus:</b> +3 XP per Pangkah, +1 XP per clean</div>
            </div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(245,158,11,0.1));border:1px solid var(--gold);border-radius:12px;padding:15px;margin-top:10px">
            <div style="font-weight:800;color:var(--gold);margin-bottom:8px;font-size:14px">üéì QUICK SUMMARY</div>
            <div style="font-size:12px;line-height:1.7">
                1Ô∏è‚É£ Empty your hand first to win<br>
                2Ô∏è‚É£ Follow suit if you can<br>
                3Ô∏è‚É£ No suit? PANGKAH! (opponent takes cards)<br>
                4Ô∏è‚É£ Last player with cards loses
            </div>
        </div>`}
];
function renderGuide(){
    const page=GUIDE_PAGES[guidePage];
    document.getElementById('guide-content').innerHTML=page.content;
    document.getElementById('guide-page-indicator').innerText=`${guidePage+1} / ${GUIDE_PAGES.length}`;
    document.getElementById('guide-prev-btn').style.display=guidePage===0?'none':'flex';
    document.getElementById('guide-next-btn').innerHTML=guidePage===GUIDE_PAGES.length-1?'DONE ‚úì':'NEXT <img src="/icon/chevron-right.svg" alt="" style="width:14px;height:14px;filter:brightness(0) invert(1)">';
}
function guideNav(dir){
    if(dir===1&&guidePage===GUIDE_PAGES.length-1){closeHowToPlay();return;}
    guidePage=Math.max(0,Math.min(GUIDE_PAGES.length-1,guidePage+dir));
    renderGuide();
}
function openHowToPlay(){guidePage=0;document.getElementById('howtoplay-modal').style.display='flex';renderGuide();}
function closeHowToPlay(){document.getElementById('howtoplay-modal').style.display='none';}

function getLevel(){return Math.floor((stats.xp||0)/XP_PER_LEVEL)+1;}
function getLevelDisplay(){return isGameMaster?'‚àû':getLevel();}
function getRankTitle(l){return isGameMaster?'GAME MASTER':l<=5?'APPRENTICE':l<=10?'WARRIOR':l<=15?'MASTER':l<=20?'GRANDMASTER':l<=30?'ELDER':l<=50?'SECT LEADER':'ANCIENT ANCESTOR';}
function getBadgeImage(l,isGM=false){return isGM?'/badge/gm-badge.png':l<=5?'/badge/apprentice-badge.png':l<=10?'/badge/warrior-badge.png':l<=15?'/badge/master-badge.png':l<=20?'/badge/grandmaster-badge.png':l<=30?'/badge/elder-badge.png':l<=50?'/badge/sectleader-badge.png':'/badge/ancientancestor-badge.png';}

// Title color based on rarity
function getTitleColor(rarity){
    switch(rarity){
        case 'legendary': return 'var(--legendary)';
        case 'epic': return 'var(--epic)';
        case 'rare': return 'var(--rare)';
        case 'common': return 'var(--common)';
        case 'special': return '#f472b6';
        default: return 'var(--text-tertiary)';
    }
}

// Title glow effect based on rarity
function getTitleGlow(rarity){
    switch(rarity){
        case 'legendary': return '0 0 15px rgba(251, 191, 36, 0.6), 0 0 30px rgba(251, 191, 36, 0.3)';
        case 'epic': return '0 0 12px rgba(168, 85, 247, 0.5), 0 0 25px rgba(168, 85, 247, 0.25)';
        case 'rare': return '0 0 10px rgba(59, 130, 246, 0.4), 0 0 20px rgba(59, 130, 246, 0.2)';
        case 'special': return '0 0 15px rgba(244, 114, 182, 0.6), 0 0 30px rgba(251, 191, 36, 0.3)';
        case 'common': return '0 0 8px rgba(156, 163, 175, 0.3)';
        default: return 'none';
    }
}

// GM Functions
async function gmLogin(){
    const pwd=prompt('Enter Game Master Password:');
    if(!pwd)return;
    try{
        const res=await fetch('/api/gm/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pwd})});
        const data=await res.json();
        if(data.success&&data.isGM){
            isGameMaster=true;
            localStorage.setItem('pGM','true');
            // Add GM exclusive titles if not already unlocked
            if(!stats.unlockedTitles.includes('celestial_marshal'))stats.unlockedTitles.push('celestial_marshal');
            if(!stats.unlockedTitles.includes('shadow_magistrate'))stats.unlockedTitles.push('shadow_magistrate');
            saveStats();
            updateStatsUI();
            // Show GM Admin buttons (both header and menu)
            document.getElementById('gm-admin-btn').style.display='block';
            document.getElementById('gm-admin-header-btn').style.display='flex';
            showToast('‚öúÔ∏è Game Master Mode Activated!',true);
        }else{
            showToast('Invalid password!',false);
        }
    }catch(e){showToast('Connection error',false);}
}
function gmLogout(){
    isGameMaster=false;
    localStorage.removeItem('pGM');
    // Hide GM Admin buttons (both header and menu)
    document.getElementById('gm-admin-btn').style.display='none';
    document.getElementById('gm-admin-header-btn').style.display='none';
    // Remove GM titles
    stats.unlockedTitles=stats.unlockedTitles.filter(t=>t!=='celestial_marshal'&&t!=='shadow_magistrate');
    if(stats.equippedTitle==='celestial_marshal'||stats.equippedTitle==='shadow_magistrate')stats.equippedTitle=null;
    saveStats();
    updateStatsUI();
    showToast('Game Master Mode Deactivated',false);
}
// Secret key combo to open GM login: press G then M within 500ms
let gmKeyBuffer=[];
document.addEventListener('keydown',e=>{
    gmKeyBuffer.push(e.key.toLowerCase());
    setTimeout(()=>gmKeyBuffer.shift(),500);
    if(gmKeyBuffer.join('').includes('gm')&&!isGameMaster){gmKeyBuffer=[];gmLogin();}
});

// Leaderboard System
let lbData=[];
let lbPage=0;
const LB_PER_PAGE=8;
let showingFullTable=false;
let hofData=[];
let hofPage=0;
const HOF_PER_PAGE=6;

async function loadHallOfFame(){
    try{
        const res=await fetch('/api/hall-of-fame');
        if(res.ok){
            hofData=await res.json();
            hofPage=0;
            renderHallOfFame();
        }
    }catch(e){console.log('Failed to load hall of fame');}
}

function renderHallOfFame(){
    const grid=document.getElementById('hof-grid');
    if(!hofData.records||hofData.records.length===0){
        grid.innerHTML='<div style="padding:20px;opacity:0.5;grid-column:1/-1">No records yet. Play some games!</div>';
        document.getElementById('hof-pagination').style.display='none';
        return;
    }
    
    const totalPages=Math.ceil(hofData.records.length/HOF_PER_PAGE)||1;
    const start=hofPage*HOF_PER_PAGE;
    const pageRecords=hofData.records.slice(start,start+HOF_PER_PAGE);
    
    grid.innerHTML=pageRecords.map(r=>{
        const borderColor = r.category === 'glory' ? 'var(--accent-gold)' : r.category === 'shame' ? 'var(--accent-red)' : 'var(--accent-blue)';
        const titleColor = r.category === 'glory' ? 'var(--accent-gold)' : r.category === 'shame' ? 'var(--accent-red)' : 'var(--accent-blue)';
        const bgTint = r.category === 'glory' ? 'rgba(251,191,36,0.08)' : r.category === 'shame' ? 'rgba(248,113,113,0.08)' : 'rgba(96,165,250,0.08)';
        return `
        <div class="hof-card" style="border-left:3px solid ${borderColor};background:${bgTint}">
            <div class="hof-card-header">
                <span class="hof-icon">${r.icon}</span>
                <div>
                    <div class="hof-card-title" style="color:${titleColor}">${r.title}</div>
                    <div class="hof-player">${r.player}</div>
                </div>
            </div>
            <div class="hof-value">${r.value}</div>
            <div class="hof-desc">${r.description}</div>
        </div>
    `}).join('');
    
    document.getElementById('hof-pagination').style.display=totalPages>1?'flex':'none';
    document.getElementById('hof-page-indicator').innerText=`${hofPage+1} / ${totalPages}`;
}

function hofNav(dir){
    if(!hofData.records)return;
    const totalPages=Math.ceil(hofData.records.length/HOF_PER_PAGE)||1;
    hofPage=Math.max(0,Math.min(totalPages-1,hofPage+dir));
    renderHallOfFame();
}

function toggleFullTable(){
    showingFullTable=!showingFullTable;
    document.getElementById('hof-container').style.display=showingFullTable?'none':'block';
    document.getElementById('full-table-section').style.display=showingFullTable?'block':'none';
    if(showingFullTable&&lbData.length===0){
        loadLeaderboard();
    }
}

async function loadLeaderboard(){
    const sortBy=document.getElementById('lb-sort').value;
    try{
        const res=await fetch(`/api/leaderboard/${sortBy}?limit=100`);
        if(res.ok){
            lbData=await res.json();
            lbPage=0;
            renderLeaderboard();
        }
    }catch(e){console.log('Failed to load leaderboard');}
}

function renderLeaderboard(){
    const tbody=document.getElementById('lb-body');
    const totalPages=Math.ceil(lbData.length/LB_PER_PAGE)||1;
    const start=lbPage*LB_PER_PAGE;
    const pageData=lbData.slice(start,start+LB_PER_PAGE);
    
    tbody.innerHTML=pageData.map((p,i)=>{
        const rank=start+i+1;
        const level=Math.floor((p.xp||0)/100)+1;
        const games=p.games||0;
        const wins=p.wins||0;
        const losses=p.losses||0;
        const secondPlace=p.secondPlace||0;
        const thirdPlace=p.thirdPlace||0;
        const fourthToTenth=p.fourthToTenth||0;
        const winRate=games>0?((wins/games)*100).toFixed(1):'0.0';
        const loseRate=games>0?((losses/games)*100).toFixed(1):'0.0';
        const pangkahs=p.pangkahs||0;
        const getPangkah=p.pangkahsReceived||0;
        const medal=rank===1?'ü•á':rank===2?'ü•à':rank===3?'ü•â':rank;
        return`<tr>
            <td class="lb-rank">${medal}</td>
            <td class="lb-name">${p.displayName||'Unknown'} <span style="opacity:0.6;font-size:9px">(${level})</span></td>
            <td>${games}</td>
            <td>${wins}</td>
            <td>${winRate}%</td>
            <td>${losses}</td>
            <td>${loseRate}%</td>
            <td>${secondPlace}</td>
            <td>${thirdPlace}</td>
            <td>${fourthToTenth}</td>
            <td>${pangkahs}</td>
            <td>${getPangkah}</td>
        </tr>`;
    }).join('');
    
    document.getElementById('lb-page-indicator').innerText=`${lbPage+1} / ${totalPages}`;
}

function lbNav(dir){
    const totalPages=Math.ceil(lbData.length/LB_PER_PAGE)||1;
    lbPage=Math.max(0,Math.min(totalPages-1,lbPage+dir));
    renderLeaderboard();
}

function openLeaderboard(){
    document.getElementById('leaderboard-modal').style.display='flex';
    showingFullTable=false;
    hofPage=0;
    document.getElementById('hof-container').style.display='block';
    document.getElementById('full-table-section').style.display='none';
    loadHallOfFame();
}

function closeLeaderboard(){
    document.getElementById('leaderboard-modal').style.display='none';
}

// ============ GM ADMIN PANEL ============
let gmCurrentPlayer = null;

function openGMAdmin(){
    if(!isGameMaster){showToast('Access denied');return;}
    document.getElementById('gm-admin-modal').style.display='flex';
    document.getElementById('gm-player-result').style.display='none';
    document.getElementById('gm-no-result').style.display='none';
    document.getElementById('gm-search-input').value='';
    gmRefreshRooms();
}

function closeGMAdmin(){
    document.getElementById('gm-admin-modal').style.display='none';
    gmCurrentPlayer=null;
}

async function gmRefreshRooms(){
    try{
        const res=await fetch('/api/gm/rooms');
        const data=await res.json();
        const container=document.getElementById('gm-rooms-list');
        if(data.rooms&&data.rooms.length>0){
            container.innerHTML=data.rooms.map(r=>`
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border-subtle)">
                    <div>
                        <span style="font-weight:600;color:#fff">#${r.id}</span>
                        <span style="font-size:10px;color:var(--text-tertiary);margin-left:8px">${r.playerCount}/${r.maxPlayers} players</span>
                        <span style="font-size:9px;padding:2px 6px;border-radius:4px;margin-left:6px;background:${r.inGame?'var(--accent-red)':'var(--accent-green)'};color:#fff">${r.inGame?'IN GAME':'LOBBY'}</span>
                    </div>
                    <button onclick="gmForceCloseRoom('${r.id}')" style="background:var(--accent-red);border:none;color:#fff;width:28px;height:28px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="Force Close">‚úï</button>
                </div>
            `).join('');
        }else{
            container.innerHTML='<div style="padding:15px;text-align:center;color:var(--text-tertiary);font-size:11px">No active rooms</div>';
        }
    }catch(e){
        console.error('Failed to fetch rooms:',e);
        document.getElementById('gm-rooms-list').innerHTML='<div style="padding:15px;text-align:center;color:var(--accent-red);font-size:11px">Failed to load rooms</div>';
    }
}

async function gmForceCloseRoom(roomID){
    if(!confirm(`Force close room #${roomID}?\n\nAll players will be kicked.`))return;
    try{
        const res=await fetch('/api/gm/force-close-room',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({roomID})
        });
        const data=await res.json();
        if(data.success){
            showToast(`Room #${roomID} closed`,true);
            gmRefreshRooms();
        }else{
            showToast(data.error||'Failed to close room');
        }
    }catch(e){
        showToast('Failed to close room');
    }
}

async function gmSearchPlayer(){
    const query=document.getElementById('gm-search-input').value.trim();
    if(!query){showToast('Enter a search term');return;}
    
    try{
        const res=await fetch(`/api/gm/search-player?q=${encodeURIComponent(query)}`);
        const data=await res.json();
        
        if(data.player){
            gmCurrentPlayer=data.player;
            document.getElementById('gm-player-result').style.display='block';
            document.getElementById('gm-no-result').style.display='none';
            
            document.getElementById('gm-player-name').innerText=data.player.displayName||'Unknown';
            document.getElementById('gm-player-id').innerText=data.player.userID;
            
            // Check if player holds any HOF frame or is GM or Beta Tester
            const statusEl=document.getElementById('gm-player-status');
            const playerFrame = getPlayerFrame(data.player.userID, false);
            if(data.player.isBetaTester){
                statusEl.innerText='BETA TESTER';
                statusEl.style.background='var(--accent-green)';
                statusEl.style.color='#fff';
            }else if(playerFrame){
                const frameName = HOF_FRAMES.find(f=>f.class===playerFrame)?.name || 'Frame Holder';
                statusEl.innerText=frameName.toUpperCase();
                statusEl.style.background='var(--accent-gold)';
                statusEl.style.color='#000';
            }else{
                statusEl.innerText='NORMAL';
                statusEl.style.background='rgba(255,255,255,0.1)';
                statusEl.style.color='#fff';
            }
            
            // Set beta tester toggle state
            document.getElementById('gm-beta-toggle').checked=data.player.isBetaTester||false;
            
            document.getElementById('gm-stat-xp').value=data.player.xp||0;
            document.getElementById('gm-stat-wins').value=data.player.wins||0;
            document.getElementById('gm-stat-losses').value=data.player.losses||0;
            document.getElementById('gm-stat-games').value=data.player.games||0;
            document.getElementById('gm-stat-pangkahs').value=data.player.pangkahs||0;
            document.getElementById('gm-stat-bestStreak').value=data.player.bestStreak||0;
        }else{
            document.getElementById('gm-player-result').style.display='none';
            document.getElementById('gm-no-result').style.display='block';
            gmCurrentPlayer=null;
        }
    }catch(e){
        console.error('GM search error:',e);
        showToast('Search failed');
    }
}

async function gmSavePlayer(){
    if(!gmCurrentPlayer){showToast('No player selected');return;}
    
    const updates={
        xp:parseInt(document.getElementById('gm-stat-xp').value)||0,
        wins:parseInt(document.getElementById('gm-stat-wins').value)||0,
        losses:parseInt(document.getElementById('gm-stat-losses').value)||0,
        games:parseInt(document.getElementById('gm-stat-games').value)||0,
        pangkahs:parseInt(document.getElementById('gm-stat-pangkahs').value)||0,
        bestStreak:parseInt(document.getElementById('gm-stat-bestStreak').value)||0
    };
    
    console.log('[GM] Saving player:', gmCurrentPlayer.userID, 'Updates:', updates);
    
    try{
        const res=await fetch('/api/gm/update-player',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({targetUserID:gmCurrentPlayer.userID,updates})
        });
        const data=await res.json();
        console.log('[GM] Save response:', data);
        if(data.success){
            showToast('Player updated!',true);
            // Refresh the search to show updated values
            gmSearchPlayer();
        }else{
            showToast(data.error||'Update failed');
        }
    }catch(e){
        console.error('GM save error:',e);
        showToast('Save failed');
    }
}

async function gmResetPlayer(){
    if(!gmCurrentPlayer){showToast('No player selected');return;}
    
    if(!confirm(`Are you sure you want to RESET ALL STATS for ${gmCurrentPlayer.displayName}?\n\nThis cannot be undone!`)){
        return;
    }
    
    try{
        const res=await fetch('/api/gm/reset-player',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({targetUserID:gmCurrentPlayer.userID})
        });
        const data=await res.json();
        if(data.success){
            showToast('Player stats reset!',true);
            gmSearchPlayer(); // Refresh the display
        }else{
            showToast(data.error||'Reset failed');
        }
    }catch(e){
        console.error('GM reset error:',e);
        showToast('Reset failed');
    }
}

async function gmToggleBetaTester(){
    if(!gmCurrentPlayer){showToast('No player selected');return;}
    
    const isBetaTester=document.getElementById('gm-beta-toggle').checked;
    
    try{
        const res=await fetch('/api/gm/toggle-beta-tester',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({targetUserID:gmCurrentPlayer.userID,isBetaTester})
        });
        const data=await res.json();
        if(data.success){
            showToast(isBetaTester?'Beta Tester status granted!':'Beta Tester status removed!',true);
            gmCurrentPlayer.isBetaTester=isBetaTester;
            // Update status badge
            const statusEl=document.getElementById('gm-player-status');
            if(isBetaTester){
                statusEl.innerText='BETA TESTER';
                statusEl.style.background='var(--accent-green)';
                statusEl.style.color='#fff';
            }else{
                const playerFrame = getPlayerFrame(gmCurrentPlayer.userID, false);
                if(playerFrame){
                    const frameName = HOF_FRAMES.find(f=>f.class===playerFrame)?.name || 'Frame Holder';
                    statusEl.innerText=frameName.toUpperCase();
                    statusEl.style.background='var(--accent-gold)';
                    statusEl.style.color='#000';
                }else{
                    statusEl.innerText='NORMAL';
                    statusEl.style.background='rgba(255,255,255,0.1)';
                    statusEl.style.color='#fff';
                }
            }
        }else{
            showToast(data.error||'Toggle failed');
            // Revert toggle state
            document.getElementById('gm-beta-toggle').checked=!isBetaTester;
        }
    }catch(e){
        console.error('GM beta toggle error:',e);
        showToast('Toggle failed');
        // Revert toggle state
        document.getElementById('gm-beta-toggle').checked=!isBetaTester;
    }
}

async function gmDeletePlayer(){
    if(!gmCurrentPlayer){showToast('No player selected');return;}
    
    // Double confirmation for delete
    if(!confirm(`‚ö†Ô∏è WARNING: Delete player "${gmCurrentPlayer.displayName}"?\n\nThis will PERMANENTLY remove all their data from the database.\nThey will start fresh on next login.\n\nThis cannot be undone!`)){
        return;
    }
    
    if(!confirm(`üö® FINAL CONFIRMATION üö®\n\nType "DELETE" in the next prompt to confirm deletion of:\n${gmCurrentPlayer.displayName} (${gmCurrentPlayer.userID})`)){
        return;
    }
    
    const confirmText = prompt('Type DELETE to confirm:');
    if(confirmText !== 'DELETE'){
        showToast('Deletion cancelled');
        return;
    }
    
    try{
        const res=await fetch('/api/gm/delete-player',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({targetUserID:gmCurrentPlayer.userID})
        });
        const data=await res.json();
        if(data.success){
            showToast(`‚ò†Ô∏è Player ${gmCurrentPlayer.displayName} deleted!`,true);
            // Hide the player result panel
            document.getElementById('gm-player-result').style.display='none';
            document.getElementById('gm-search-input').value='';
            gmCurrentPlayer=null;
        }else{
            showToast(data.error||'Delete failed');
        }
    }catch(e){
        console.error('GM delete error:',e);
        showToast('Delete failed');
    }
}
// ============ END GM ADMIN PANEL ============

// Stats are now managed server-side - no local saving needed
function saveStats(){
    // Stats are saved on server after each game
    // This function is kept for compatibility but does nothing
}

// Equip title via server API
async function equipTitleOnServer(titleId){
    try{
        console.log('equipTitleOnServer called with:', titleId, 'for userID:', userID);
        const res = await fetch('/api/player/equip-title', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userID, titleId })
        });
        console.log('Server response status:', res.status);
        if(res.ok){
            const data = await res.json();
            console.log('Server response data:', data);
            stats.equippedTitle = data.equippedTitle;
            updateStatsUI();
            return true;
        } else {
            const errData = await res.json().catch(()=>({}));
            console.log('Server error:', errData);
        }
    }catch(e){ console.log('Failed to equip title:', e); }
    return false;
}

function addXP(amt,reason,popup=true){
    // XP is now added server-side after games
    // This function is kept for compatibility but XP comes from server
    if(popup&&amt){
        const p=document.createElement('div');
        p.className='xp-popup';
        p.style.color=amt>0?'var(--primary-action)':'var(--danger)';
        p.innerText=`${amt>0?'+':''}${amt} XP`;
        document.body.appendChild(p);
        setTimeout(()=>p.remove(),1500);
    }
}
function updateStatsUI(){const lv=getLevel(),lvDisplay=getLevelDisplay(),rt=getRankTitle(lv),xp=(stats.xp||0)%XP_PER_LEVEL,wr=stats.games>0?((stats.wins/stats.games)*100).toFixed(1):0,eq=getEquippedTitleData();const mn=document.getElementById('menu-name');if(mn)mn.innerText=myName;const mb=document.getElementById('menu-badge');if(mb)mb.src=getBadgeImage(lv,isGameMaster);const mtitle=document.getElementById('menu-title');if(mtitle)mtitle.innerHTML=eq?`<span class="title-rarity ${eq.rarity}" style="font-size:9px;padding:1px 5px">${eq.icon} ${eq.name}</span>`:'<span style="opacity:0.6">No title equipped</span>';document.getElementById('prof-name').innerText=myName;document.getElementById('prof-level').innerText=isGameMaster?'‚àû':`LEVEL ${lvDisplay}`;document.getElementById('prof-rank-title').innerText=rt;document.getElementById('prof-xp').innerText=stats.xp||0;document.getElementById('prof-wins').innerText=stats.wins||0;document.getElementById('prof-pangkahs').innerText=stats.pangkahs||0;document.getElementById('prof-games').innerText=stats.games||0;document.getElementById('prof-streak').innerText=stats.bestStreak||0;document.getElementById('prof-winrate').innerText=wr+'%';document.getElementById('prof-progress-text').innerText=isGameMaster?'‚àû XP':`XP: ${xp}/${XP_PER_LEVEL}`;document.getElementById('prof-bar-fill').style.width=isGameMaster?'100%':(xp/XP_PER_LEVEL*100)+'%';document.getElementById('prof-equipped-title').innerHTML=eq?`<span class="title-rarity ${eq.rarity}">${eq.icon} ${eq.name}</span>`:'<span style="opacity:0.5;font-size:11px">No title equipped</span>';document.getElementById('streak-indicator').style.display=stats.currentStreak>=3?'block':'none';document.getElementById('streak-count').innerText=stats.currentStreak||0;document.getElementById('gm-logout-btn').style.display=isGameMaster?'block':'none';}
function editName(){const n=prompt("Enter Name:",myName);if(n?.trim()&&n.trim().length<=20){myName=n.trim();localStorage.setItem('pName',myName);updateStatsUI();}}
async function editNamePrompt(){
    const n=prompt("Enter new name (max 20 characters):",myName);
    if(!n||!n.trim())return;
    const trimmed=n.trim();
    if(trimmed.length>20){showToast('Name must be 20 characters or less');return;}
    if(trimmed.length<1){showToast('Name cannot be empty');return;}
    try{
        const res=await fetch('/api/player/update-name',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({userID,displayName:trimmed})
        });
        if(res.ok){
            myName=trimmed;
            localStorage.setItem('pName',myName);
            updateStatsUI();
            showToast('Name updated!',true);
        }else{
            const err=await res.json();
            showToast(err.error||'Failed to update name');
        }
    }catch(e){
        // Fallback to local only
        myName=trimmed;
        localStorage.setItem('pName',myName);
        updateStatsUI();
        showToast('Name updated locally',true);
    }
}
function openProfile(){updateStatsUI();document.getElementById('profile-modal').style.display='flex';}
function closeProfile(){document.getElementById('profile-modal').style.display='none';}
function openHowToPlay(){document.getElementById('howtoplay-modal').style.display='flex';}
function closeHowToPlay(){document.getElementById('howtoplay-modal').style.display='none';}

// Mobile header hamburger menu
function toggleHeaderMenu(){
    const menu=document.getElementById('header-menu');
    if(!menu)return;
    const isOpen=menu.classList.toggle('open');
    menu.setAttribute('aria-hidden',isOpen?'false':'true');
}
function closeHeaderMenu(){
    const menu=document.getElementById('header-menu');
    if(!menu)return;
    menu.classList.remove('open');
    menu.setAttribute('aria-hidden','true');
}
document.addEventListener('click',e=>{
    const menu=document.getElementById('header-menu');
    const btn=document.getElementById('hamburger-btn');
    if(!menu||!btn)return;
    if(!menu.classList.contains('open'))return;
    const clickedInsideMenu=menu.contains(e.target);
    const clickedBtn=btn.contains(e.target);
    if(!clickedInsideMenu&&!clickedBtn)closeHeaderMenu();
});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeHeaderMenu();});
function showToast(msg,pos=false){const t=document.getElementById('toast');t.innerText=msg;t.style.background=pos?'var(--primary-action)':'var(--danger)';t.style.display='block';setTimeout(()=>t.style.display='none',3000);}
function showLoading(s){document.getElementById('loading').style.display=s?'flex':'none';}
function flashScreen(type){const f=document.createElement('div');f.className=type+'-flash';document.body.appendChild(f);setTimeout(()=>f.remove(),500);}

// Turn Indicator - Screen Edge Glow + Inline
function setTurnIndicator(isMyTurn){
    document.getElementById('turn-glow').classList.toggle('active',isMyTurn);
    document.getElementById('turn-indicator-inline').classList.toggle('active',isMyTurn);
}

// Quick Emotes
function sendEmote(emoji){
    if(!myRoom)return;
    socket.emit('sendEmote',{roomID:myRoom,userID,playerName:myName,emoji});
    showEmote(emoji,myName,true);
}
function showEmote(emoji,fromName,isMe=false){
    const e=document.createElement('div');
    e.className='emote-float';
    e.innerHTML=`${emoji}<div class="emote-from">${isMe?'You':fromName}</div>`;
    e.style.left=Math.random()*60+20+'%';
    e.style.top='50%';
    document.body.appendChild(e);
    setTimeout(()=>e.remove(),2000);
}
socket.on('receiveEmote',d=>{
    if(d.userID!==userID)showEmote(d.emoji,d.playerName);
});

// Confetti Effect
function launchConfetti(){
    const colors=['#fbbf24','#f59e0b','#10b981','#3b82f6','#a855f7','#f43f5e','#ffffff'];
    const shapes=['square','circle','star'];
    for(let i=0;i<100;i++){
        setTimeout(()=>{
            const c=document.createElement('div');
            c.className='confetti '+shapes[Math.floor(Math.random()*shapes.length)];
            c.style.left=Math.random()*100+'%';
            c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
            c.style.animationDuration=(Math.random()*2+2)+'s';
            c.style.width=(Math.random()*8+6)+'px';
            c.style.height=c.style.width;
            document.body.appendChild(c);
            setTimeout(()=>c.remove(),4000);
        },i*30);
    }
}

function enter(type){myRoom=document.getElementById('rid').value.trim();if(!myRoom)return showToast("Sect ID Required");showLoading(true);const data={roomID:myRoom,playerName:myName,userID,equippedTitle:getEquippedTitleData(),level:getLevel(),isGM:isGameMaster};if(type==='create'){data.maxPlayers=document.getElementById('maxp').value;data.botCount=document.getElementById('botcount').value;currentMaxPlayers=parseInt(data.maxPlayers);isHost=true;}socket.emit(type==='create'?'createRoom':'joinRoom',data);}
function start(){const btn=document.getElementById('start-btn');if(btn.disabled)return;showLoading(true);socket.emit('startGame',myRoom);}
function closeRoom(){if(myRoom&&confirm("Disband this sect?"))socket.emit('requestCloseRoom',{roomID:myRoom});}
function backToLobby(){
    // Clear room data and disconnect
    if(myRoom){
        socket.emit('leaveRoom',{roomID:myRoom,userID});
    }
    // Clear local state
    myRoom='';
    myCurrentHand=[];
    isHost=false;
    isFirstMove=true;
    currentLeadSuit=null;
    // Clear session storage to force fresh start
    sessionStorage.removeItem('pRoom');
    // Reload page to go back to lobby
    location.reload();
}

function requestRematch(){
    if(!myRoom) return;
    socket.emit('requestRematch',{roomID:myRoom,userID});
    const btn=document.getElementById('rematch-btn');
    if(btn){
        btn.disabled=true;
        btn.style.opacity='0.6';
    }
    showToast("Waiting for others...",true);
}

function sortHand(){const o={Spades:4,Hearts:3,Diamonds:2,Clubs:1};myCurrentHand.sort((a,b)=>(o[b.suit]-o[a.suit])||(b.val-a.val));renderHand();}
function answerSwap(accept){if(swapTimeoutId)clearTimeout(swapTimeoutId);document.getElementById('swap-modal').style.display='none';if(accept&&pendingSwapRequest)socket.emit('acceptSwap',{roomID:myRoom,fromUserID:pendingSwapRequest,myUserID:userID});pendingSwapRequest=null;}

socket.on('connect',()=>{document.getElementById('connection-status').innerHTML='üü¢ Connected';socket.emit('checkSession',{userID});});
socket.on('disconnect',()=>{document.getElementById('connection-status').innerHTML='üî¥ Disconnected';showToast("Connection lost...");});
socket.on('reconnectSuccess',d=>{myRoom=d.roomID;isFirstMove=d.isFirstMove||false;currentLeadSuit=d.currentSuit;if(d.players[0]?.userID===userID){isHost=true;document.getElementById('close-room-btn').style.display='block';}showLoading(false);document.getElementById('lobby').style.display='none';document.getElementById('room-tag').innerText="SECT: "+myRoom;showToast("Reconnected!",true);update(d);});
socket.on('roomList',list=>{const box=document.getElementById('room-box');box.innerHTML=list.length?"":'<div style="padding:15px;opacity:0.3">No active sects...</div>';list.forEach(r=>{const d=document.createElement('div');d.className=`room-item ${r.inGame?'in-game':''}`;d.innerHTML=`<span>#${r.id}</span><span>${r.count}/${r.max}${r.inGame?' üéÆ':''}</span>`;d.onclick=()=>{if(!r.inGame)document.getElementById('rid').value=r.id;};box.appendChild(d);});});

// Handle room joined (for both create and join)
socket.on('roomJoined',d=>{
    showLoading(false);
    myRoom=d.roomID;
    isHost=d.isHost;
    currentMaxPlayers=d.maxPlayers;
    document.getElementById('lobby').style.display='none';
    document.getElementById('room-tag').innerText="SECT: "+myRoom;
    document.getElementById('close-room-btn').style.display=isHost?'block':'none';
    
    // Setup start button
    const startBtn=document.getElementById('start-btn');
    const p=d.players;
    const isFull=p.length>=d.maxPlayers;
    startBtn.style.display=isHost?'block':'none';
    startBtn.innerText=`BEGIN DUEL (${p.length}/${d.maxPlayers})`;
    startBtn.disabled=!isFull;
    startBtn.style.background=isFull?'var(--primary-action)':'rgba(100,116,139,0.8)';
    startBtn.style.color=isFull?'#000':'rgba(255,255,255,0.7)';
    startBtn.style.cursor=isFull?'pointer':'not-allowed';
    startBtn.style.border=isFull?'none':'2px solid rgba(255,255,255,0.3)';
    
    render(p,-1);
    showToast(isHost?"Sect created!":"Joined sect!",true);
});

// Handle player joined (updates for existing room members)
socket.on('playerJoined',d=>{
    const p=d.players;
    const maxP=d.maxPlayers||currentMaxPlayers;
    currentMaxPlayers=maxP;
    
    // Update start button
    const startBtn=document.getElementById('start-btn');
    const isFull=p.length>=maxP;
    startBtn.innerText=`BEGIN DUEL (${p.length}/${maxP})`;
    startBtn.disabled=!isFull;
    startBtn.style.background=isFull?'var(--primary-action)':'rgba(100,116,139,0.8)';
    startBtn.style.color=isFull?'#000':'rgba(255,255,255,0.7)';
    startBtn.style.cursor=isFull?'pointer':'not-allowed';
    startBtn.style.border=isFull?'none':'2px solid rgba(255,255,255,0.3)';
    
    render(p,-1);
    showToast("A disciple joined!",true);
});

socket.on('updatePlayers',(p,roomData)=>{showLoading(false);document.getElementById('lobby').style.display='none';document.getElementById('room-tag').innerText="SECT: "+myRoom;isHost=p[0]?.userID===userID;document.getElementById('close-room-btn').style.display=isHost?'block':'none';
// Update start button with player count
const startBtn=document.getElementById('start-btn');
const maxP=roomData?.maxPlayers||currentMaxPlayers||p.length;
currentMaxPlayers=maxP;
const isFull=p.length>=maxP;
startBtn.style.display=isHost?'block':'none';
startBtn.innerText=`BEGIN DUEL (${p.length}/${maxP})`;
startBtn.disabled=!isFull;
startBtn.style.background=isFull?'var(--primary-action)':'rgba(100,116,139,0.8)';
startBtn.style.color=isFull?'#000':'rgba(255,255,255,0.7)';
startBtn.style.cursor=isFull?'pointer':'not-allowed';
startBtn.style.border=isFull?'none':'2px solid rgba(255,255,255,0.3)';
p.forEach(pl=>{if(pl.userID!==userID&&!stats.uniquePlayers.includes(pl.userID))stats.uniquePlayers.push(pl.userID);});saveStats();render(p,-1);});
socket.on('gameStarted',d=>{showLoading(false);document.getElementById('round-popup').style.display='none';document.getElementById('gameover-modal').style.display='none';document.getElementById('start-btn').style.display='none';isProcessingTurn=false;isFirstMove=true;currentLeadSuit=null;document.getElementById('close-room-btn').style.display=isHost?'block':'none';update({players:d.players,turn:d.turn,table:[]});showToast(`Game #${d.gameNumber} started!`,true);});
socket.on('clearTable',d=>{
    // First, render the final table so players can see all cards
    if(d.finalTable && d.finalTable.length > 0){
        const tLayer=document.getElementById('t-layer');
        tLayer.innerHTML="";
        const rowDiv=document.createElement('div');
        rowDiv.className='table-cards-row';
        d.finalTable.forEach((tc)=>{
            const el=createCardUI(tc.card);
            el.className=`card table-card ${['Hearts','Diamonds'].includes(tc.card.suit)?'red':''}`;
            rowDiv.appendChild(el);
        });
        tLayer.appendChild(rowDiv);
    }
    
    if(d.msg.toLowerCase()==='pangkah!'){
        flashScreen('pangkah');playSound('strike');
        // Track pangkah received (the one who took the cards)
        if(d.winnerUserID===userID){addXP(0,"Got Pangkah'd",false);}
        // Track pangkah dealt (the one who broke suit)
        if(d.pangkahDealerUserID===userID){addXP(3,"Pangkah Dealt!",true);}
    }else{
        flashScreen('clean');playSound('sweep');
        if(d.winnerUserID===userID){addXP(1,"Clean Round",true);}
    }
    
    currentLeadSuit=null;
    const pop=document.getElementById('round-popup');
    document.getElementById('pop-title').className=d.msg==='Pangkah!'?'pangkah-text':'clean-text';
    document.getElementById('pop-title').innerText=d.msg.toUpperCase();
    document.getElementById('pop-desc').innerText=d.winner+" has the lead.";
    pop.style.display='block';
    
    // Show popup for 2 seconds, then clear table and update
    setTimeout(()=>{
        pop.style.display='none';
        update({players:d.players,turn:d.turn,table:[],fateAces:d.fateAces});
    },2000);
});

// Handle card played - shows card on table immediately
socket.on('cardPlayed',d=>{
    playSound('place');
    if(d.leadSuit)currentLeadSuit=d.leadSuit;
    if(d.table?.length>0)isFirstMove=false;
    
    // Update the game state
    update(d);
    
    // If pangkah, show indicator
    if(d.isPangkah){
        showToast(`üí• ${d.playerName} PANGKAH!`,false);
    }
});

socket.on('updateTable',d=>{playSound('place');if(d.currentSuit)currentLeadSuit=d.currentSuit;if(d.table?.length>0)isFirstMove=false;update(d);});
socket.on('nextTurn',d=>{if(d.currentSuit)currentLeadSuit=d.currentSuit;update(d);});
socket.on('errorMsg',m=>{showLoading(false);isProcessingTurn=false;showToast(m);});
socket.on('roomClosed',()=>{showToast("Sect disbanded");setTimeout(()=>location.reload(),2000);});

socket.on('gameOver',data=>{
    setTurnIndicator(false);
    document.getElementById('close-room-btn').style.display='none';
    
    // Stats are now handled server-side - we just display the results
    const myPos=data.finishOrder.indexOf(userID)+1;
    const myData=data.performanceData.find(p=>p.userID===userID);
    
    // Visual effects only
    if(myPos===1){
        launchConfetti();
    }
    
    // Display game results UI
    document.getElementById('game-number').innerText=`Game #${data.gameNumber}`;
    document.getElementById('finish-list').innerHTML=data.performanceData.sort((a,b)=>a.position-b.position).map(p=>{
        const isW=p.position===1,isL=p.position===data.performanceData.length,isMe=p.userID===userID;
        let xp=isW?15:p.position===2?8:p.position===3?5:isL?-2:3;
        const tHtml=p.equippedTitle?`<span class="title-rarity ${p.equippedTitle.rarity}" style="font-size:8px;margin-left:5px">${p.equippedTitle.icon}</span>`:'';
        return`<div class="finish-item ${isW?'winner':''} ${isL?'loser':''}" style="${isMe?'border-width:2px':''}"><div style="font-size:18px;font-weight:800;width:30px">${isW?'üëë':isL?'üíÄ':'#'+p.position}</div><div style="flex:1;text-align:left;margin-left:10px;font-weight:600">${p.name}${tHtml}${isMe?' (You)':''}</div><div style="font-size:12px;color:var(--primary-action);font-weight:800">${xp>0?'+':''}${xp} XP</div></div>`;
    }).join('');
    
    // Build bonus list for display (actual XP handled server-side)
    let bonuses=[];
    if(myPos===1){
        bonuses.push({n:'üèÜ Victory',x:15});
    }else if(myPos===2){
        bonuses.push({n:'ü•à 2nd',x:8});
    }else if(myPos===3){
        bonuses.push({n:'ü•â 3rd',x:5});
    }else if(data.loserUserID===userID){
        bonuses.push({n:'üíÄ Defeated',x:-2});
    }
    if(myData?.stats?.pangkahsDealt)bonuses.push({n:`‚ö° Pangkahs (${myData.stats.pangkahsDealt})`,x:myData.stats.pangkahsDealt*3});
    if(myData?.stats?.cleanWins)bonuses.push({n:`‚ú® Clean (${myData.stats.cleanWins})`,x:myData.stats.cleanWins});
    const total=bonuses.reduce((s,b)=>s+b.x,0);
    
    document.getElementById('bonus-list').innerHTML=`<div style="font-weight:800;margin-bottom:10px;color:var(--gold)">üéÅ YOUR BONUSES</div>${bonuses.map(b=>`<div class="bonus-item"><span>${b.n}</span><span style="color:${b.x>=0?'var(--primary-action)':'var(--danger)'};font-weight:800">${b.x>0?'+':''}${b.x} XP</span></div>`).join('')}<div class="bonus-item" style="border-top:2px solid var(--gold);margin-top:10px;padding-top:10px"><span style="font-weight:800">TOTAL</span><span style="color:var(--gold);font-weight:800;font-size:16px">${total>0?'+':''}${total} XP</span></div>`;
    
    document.getElementById('gameover-modal').style.display='flex';
});
socket.on('receiveSwapRequest',d=>{pendingSwapRequest=d.fromUserID;document.getElementById('swap-txt').innerText=d.fromName+" wants your hand!";document.getElementById('swap-modal').style.display='block';let t=15;const timer=document.getElementById('swap-timer');timer.innerText=`${t}s`;const cd=setInterval(()=>{t--;timer.innerText=`${t}s`;if(t<=0)clearInterval(cd);},1000);swapTimeoutId=setTimeout(()=>{clearInterval(cd);if(pendingSwapRequest===d.fromUserID){answerSwap(false);showToast("Swap expired");}},15000);});
socket.on('swapOccurred',d=>{playSound('absorb');showToast(d.msg,true);update(d);});
socket.on('swapDeclined',()=>{showToast("Swap request declined",false);});
socket.on('botSwapPending',d=>{showToast(`${d.botName} will accept in ${d.countdown}s...`,true);});

// Bot Emotes
socket.on('botEmote',d=>{
    showToast(`ü§ñ ${d.botName}: ${d.emote}`,true);
});

// Rematch system
socket.on('rematchStatus',d=>{
    const btn=document.getElementById('rematch-btn');
    if(btn) btn.innerText=`REMATCH (${d.readyCount}/${d.totalCount})`;
    if(d.allReady){
        showToast("All ready! Starting new game...",true);
    }
});

// Player left room
socket.on('playerLeft',d=>{
    showToast(`${d.name} left the sect`,false);
});

// Player title updated
socket.on('playerTitleUpdated',d=>{
    // Re-render players with new title
    if(d.players) render(d.players, -1);
});

// Turn Timer
socket.on('turnTimer',d=>{
    const timerEl=document.getElementById('turn-timer');
    if(d.timeLeft>0){
        timerEl.innerText=`(${d.timeLeft}s)`;
        timerEl.style.color=d.timeLeft<=5?'var(--danger)':'inherit';
    }else{
        timerEl.innerText='';
    }
});

// Auto-play - includes full game state for proper render
socket.on('autoPlayed',d=>{
    showToast(`‚è±Ô∏è ${d.playerName} auto-played: ${d.card.rank}${icons[d.card.suit]}`,false);
    playSound('place');
    if(d.currentSuit)currentLeadSuit=d.currentSuit;
    if(d.table?.length>0)isFirstMove=false;
    update(d);
});

function update(d){isProcessingTurn=false;showLoading(false);const me=d.players.find(p=>p.userID===userID);if(me){myCurrentHand=me.hand;}const active=d.players[d.turn];const isMyTurn=active?.userID===userID;setTurnIndicator(isMyTurn);const sInd=document.getElementById('suit-indicator');if(d.table?.length>0){sInd.style.display='flex';currentLeadSuit=d.table[0].card.suit;document.getElementById('suit-symbol').innerText=icons[currentLeadSuit];document.getElementById('suit-symbol').style.color=['Hearts','Diamonds'].includes(currentLeadSuit)?'var(--danger)':'white';}else{sInd.style.display='none';currentLeadSuit=null;}render(d.players,d.turn,d.table||[]);if(d.fateAces)showFateInHeader(d.fateAces);}

// 2-Row Layout Configuration
function getRowConfig(playerCount){
    const configs={4:[2,2],5:[3,2],6:[3,3],7:[4,3],8:[4,4],10:[5,5]};
    return configs[playerCount]||[Math.ceil(playerCount/2),Math.floor(playerCount/2)];
}

function render(players,turn,table=[]){
    const pLayer=document.getElementById('p-layer');
    pLayer.innerHTML="";
    const myIdx=players.findIndex(p=>p.userID===userID);
    const [topCount,bottomCount]=getRowConfig(players.length);
    const gameArea=document.getElementById('game-view');
    const areaWidth=gameArea.offsetWidth;
    const areaHeight=gameArea.offsetHeight;
    
    // Calculate positions
    const avatarWidth=205;
    const topY=20;
    const bottomY=areaHeight-90;
    
    players.forEach((p,i)=>{
        let x,y;
        if(i<topCount){
            // Top row - left to right
            const spacing=areaWidth/(topCount+1);
            x=spacing*(i+1);
            y=topY;
        }else{
            // Bottom row - left to right (reversed order visually for clockwise)
            const bottomIdx=i-topCount;
            const spacing=areaWidth/(bottomCount+1);
            x=spacing*(bottomCount-bottomIdx);
            y=bottomY;
        }
        
        // Check if this player is next for swap
        let canSwap=false;
        let canSwapGreyed=false;
        const isMyTurn=turn===myIdx;
        const isBot=p.isBot||false;
        if(players.length>1&&i!==myIdx&&p.hand.length>0){
            let nxt=(myIdx+1)%players.length,att=0;
            while(players[nxt].hand.length===0&&att<players.length){nxt=(nxt+1)%players.length;att++;}
            if(i===nxt&&att<players.length){
                if(isMyTurn){
                    canSwap=true;
                }else{
                    canSwapGreyed=true;
                }
            }
        }
        
        const playerLevel=p.level||1;
        const playerIsGM=p.isGM||false;
        const titleData=p.equippedTitle;
        const titleText=isBot?'ü§ñ Bot':titleData?`${titleData.icon||''} ${titleData.name}`:'';
        const titleColor=titleData?getTitleColor(titleData.rarity):'var(--text-tertiary)';
        const badgeImg=getBadgeImage(playerLevel,playerIsGM);
        const displayLevel=isBot?'BOT':playerIsGM?'‚àû':playerLevel;
        const nameColor=p.userID===userID?'var(--ui-blue)':isBot?'var(--accent-purple)':'#fff';
        const hofFrame=getPlayerFrame(p.userID, playerIsGM);
        const frameClass=hofFrame?`av ${hofFrame}`:'av';
        
        // Title frame glow based on rarity
        const titleGlow=titleData?getTitleGlow(titleData.rarity):'none';
        
        const div=document.createElement('div');
        div.className=`player ${i===turn?'active':''} ${p.hand.length===0?'eliminated':''}`;
        div.style.position='absolute';
        div.style.left=`${x}px`;
        div.style.top=`${y}px`;
        div.style.transform='translateX(-50%)';
        const thClass=canSwap?'visible':canSwapGreyed?'visible greyed':'';
        div.innerHTML=`<div class="${frameClass}" style="box-shadow:${titleGlow}">
<div class="av-take-hand ${thClass}" onclick="event.stopPropagation();socket.emit('sendSwapRequest',{roomID:'${myRoom}',fromUserID:'${userID}'})" title="Take Hand"></div>
<div class="av-avatar"><img src="${badgeImg}" alt="badge" style="width:100%;height:100%;object-fit:contain"></div>
<div class="av-info">
<div class="av-level" ${isBot?'style="color:var(--accent-purple)"':''}>LVL ${displayLevel}</div>
<div class="av-name" style="color:${nameColor}">${p.name}</div>
<div class="av-title" style="color:${titleColor}">${titleText}</div>
</div>
<div class="av-cards">${p.hand.length}</div>
</div>`;
        pLayer.appendChild(div);
    });
    
    renderHand();
    
    // Render table cards
    const tLayer=document.getElementById('t-layer');
    tLayer.innerHTML="";
    if(table.length>0){
        const rowDiv=document.createElement('div');
        rowDiv.className='table-cards-row';
        table.forEach((tc)=>{
            const el=createCardUI(tc.card);
            el.className=`card table-card ${['Hearts','Diamonds'].includes(tc.card.suit)?'red':''}`;
            rowDiv.appendChild(el);
        });
        tLayer.appendChild(rowDiv);
    }
}

// Show Fate aces in header instead of game area
function showFateInHeader(list){
    const fateEl=document.getElementById('fate-display');
    if(!list||list.length===0){
        fateEl.style.display='none';
        return;
    }
    fateEl.style.display='flex';
    const isBlack=s=>['Spades','Clubs'].includes(s);
    fateEl.innerHTML=`<span style="color:var(--gold);margin-right:5px">‚ö∞Ô∏è</span>`+list.map(c=>`<span style="color:${isBlack(c.suit)?'#fff':'var(--danger)'};font-weight:800;margin:0 2px">A${icons[c.suit]}</span>`).join('');
}

function renderHand(){const hDiv=document.getElementById('my-cards');hDiv.innerHTML="";const isMyTurn=document.getElementById('turn-glow').classList.contains('active');const hasLead=currentLeadSuit&&myCurrentHand.some(c=>c.suit===currentLeadSuit);myCurrentHand.forEach(c=>{const el=createCardUI(c);let canPlay=true,highlight=false;if(!isMyTurn||isProcessingTurn)canPlay=false;else if(isFirstMove){canPlay=c.suit==='Spades'&&c.rank==='K';highlight=canPlay;}else if(currentLeadSuit&&hasLead){canPlay=c.suit===currentLeadSuit;highlight=canPlay;}else highlight=isMyTurn;if(!canPlay)el.classList.add('disabled');else if(highlight)el.classList.add('highlight');el.onclick=e=>{if(!isProcessingTurn&&isMyTurn&&canPlay){e.currentTarget.classList.add('disabled');e.currentTarget.classList.remove('highlight');isProcessingTurn=true;showLoading(true);socket.emit('playCard',{roomID:myRoom,cardObject:c});}};hDiv.appendChild(el);});}
function createCardUI(c){const d=document.createElement('div');d.className=`card ${['Hearts','Diamonds'].includes(c.suit)?'red':''}`;d.innerHTML=`<div style="font-size:10px">${c.rank}</div><div style="font-size:28px;text-align:center">${icons[c.suit]}</div><div style="font-size:10px;transform:rotate(180deg)">${c.rank}</div>`;return d;}
function showDiscarded(list){showFateInHeader(list);}
// Stats are loaded from server via loadPlayerData() in DOMContentLoaded
window.addEventListener('beforeunload',e=>{if(myRoom&&document.getElementById('lobby').style.display==='none'){e.preventDefault();e.returnValue='';}});
</script>
</body>
</html>
